<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Re:Kingdom - Áü•Ë≠ò„ÅÆÁéãÂõΩ„ÇíÂèñ„ÇäÊàª„Åõ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-darkest: #0a0a0f;
      --bg-dark: #12121a;
      --bg-medium: #1a1a2e;
      --bg-light: #252540;
      --accent-gold: #c9a227;
      --accent-gold-light: #e8c547;
      --accent-red: #8b2942;
      --accent-red-light: #a83250;
      --text-primary: #e8e6e3;
      --text-secondary: #9a9a9a;
      --text-dim: #5a5a6a;
      --prosperity-high: #2d5a3d;
      --prosperity-medium: #5a5a2d;
      --prosperity-low: #5a2d2d;
      --border-subtle: rgba(201, 162, 39, 0.2);
      --shadow-glow: rgba(201, 162, 39, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg-darkest);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: 100dvh;
      overflow: hidden;
    }
    .app-container { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
    header {
      padding: 0.75rem 1rem;
      background: linear-gradient(180deg, rgba(18, 18, 26, 0.95) 0%, rgba(18, 18, 26, 0.8) 100%);
      border-bottom: 1px solid var(--border-subtle);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 100; backdrop-filter: blur(10px);
    }
    .logo { font-family: 'Cinzel', serif; font-size: 1.25rem; font-weight: 700; color: var(--accent-gold); text-shadow: 0 0 20px var(--shadow-glow); }
    .logo span { color: var(--text-primary); font-weight: 400; }
    .header-stats { display: flex; gap: 1rem; font-size: 0.8rem; }
    .streak-display { color: var(--accent-gold-light); font-weight: 600; }
    .streak-display .stat-value { color: var(--accent-gold); }
    .streak-milestone { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9000; background: rgba(10, 10, 15, 0.9); border: 2px solid var(--accent-gold); border-radius: 16px; padding: 2rem; text-align: center; min-width: 280px; backdrop-filter: blur(8px); animation: milestoneAppear 0.5s ease; }
    .streak-milestone .milestone-icon { font-size: 3rem; margin-bottom: 0.5rem; }
    .streak-milestone .milestone-title { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--accent-gold); margin-bottom: 0.25rem; }
    .streak-milestone .milestone-subtitle { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; }
    .streak-milestone .milestone-btn { padding: 0.5rem 1.5rem; background: var(--accent-gold); color: var(--bg-darkest); border: none; border-radius: 8px; font-family: 'Noto Sans JP', sans-serif; font-size: 0.85rem; cursor: pointer; }
    @keyframes milestoneAppear { from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
    /* ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É† */
    .achievements-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; padding: 0.75rem; overflow-y: auto; }
    .achievement-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-medium); border: 1px solid var(--border-color); border-radius: 10px; transition: all 0.3s ease; }
    .achievement-card.unlocked { border-color: var(--accent-gold); background: linear-gradient(135deg, rgba(201,162,39,0.08), var(--bg-medium)); }
    .achievement-card.locked { opacity: 0.5; }
    .achievement-icon { font-size: 1.8rem; min-width: 2.5rem; text-align: center; }
    .achievement-card.locked .achievement-icon { filter: grayscale(1); }
    .achievement-info { flex: 1; min-width: 0; }
    .achievement-name { font-family: 'Cinzel', serif; font-size: 0.85rem; color: var(--accent-gold); margin-bottom: 0.15rem; }
    .achievement-card.locked .achievement-name { color: var(--text-secondary); }
    .achievement-desc { font-size: 0.75rem; color: var(--text-secondary); line-height: 1.3; }
    .achievement-date { font-size: 0.65rem; color: var(--accent-gold-light); margin-top: 0.2rem; }
    .achievement-progress { min-width: 3rem; text-align: right; font-size: 0.7rem; color: var(--text-secondary); }
    .achievement-summary { display: flex; justify-content: center; gap: 1.5rem; padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-secondary); }
    .achievement-summary .ach-count { color: var(--accent-gold); font-weight: 600; font-size: 1rem; }
    .items-summary { display: flex; justify-content: center; gap: 1.5rem; padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; color: var(--text-secondary); }
    .items-summary .item-count { color: var(--accent-gold); font-weight: 600; font-size: 1rem; }
    .items-grid { display: grid; grid-template-columns: 1fr; gap: 0.5rem; padding: 0.75rem; overflow-y: auto; }
    .item-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-medium); border: 1px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
    .item-card:hover { border-color: var(--accent-gold); transform: translateX(2px); }
    .item-card.owned { border-color: var(--accent-gold); background: linear-gradient(135deg, rgba(201,162,39,0.08), var(--bg-medium)); }
    .item-card.not-owned { opacity: 0.4; cursor: default; }
    .item-card.not-owned:hover { border-color: var(--border-color); transform: none; }
    .item-card .item-icon { font-size: 1.5rem; min-width: 2rem; text-align: center; }
    .item-card .item-info { flex: 1; }
    .item-card .item-name { font-size: 0.85rem; font-weight: 500; color: var(--text-primary); }
    .item-card .item-type { font-size: 0.7rem; color: var(--text-secondary); }
    .item-card.not-owned .item-icon { filter: grayscale(1); }
    .item-card.not-owned .item-name { color: var(--text-secondary); }
    .item-detail-icon { font-size: 3rem; text-align: center; margin-bottom: 0.5rem; }
    .item-detail-name { font-size: 1.1rem; font-weight: 600; color: var(--accent-gold); text-align: center; margin-bottom: 0.25rem; }
    .item-detail-type { font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 1rem; }
    .item-detail-desc { font-size: 0.85rem; color: var(--text-primary); margin-bottom: 1rem; line-height: 1.6; }
    .item-detail-lore { font-size: 0.8rem; color: var(--text-secondary); font-style: italic; border-left: 2px solid var(--accent-gold); padding-left: 0.75rem; margin-bottom: 1rem; line-height: 1.6; }
    .item-detail-date { font-size: 0.75rem; color: var(--text-secondary); text-align: center; }
    .sync-btn { background: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.3rem 0.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; transition: all 0.3s ease; position: relative; }
    .sync-btn:hover { border-color: var(--accent-gold); }
    .sync-btn .sync-icon { font-size: 0.9rem; }
    .sync-status-dot { width: 6px; height: 6px; border-radius: 50%; background: #666; }
    .sync-status-dot.connected { background: #4caf50; }
    .sync-status-dot.syncing { background: #ffc107; animation: pulse 1s infinite; }
    .sync-status-dot.error { background: #f44336; }
    .sync-config-area { width: 100%; min-height: 80px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 0.7rem; padding: 0.5rem; resize: vertical; }
    .sync-id-input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-family: monospace; font-size: 0.85rem; padding: 0.5rem; }
    .sync-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    .sync-actions button { flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-medium); color: var(--text-primary); cursor: pointer; font-size: 0.8rem; transition: all 0.3s; }
    .sync-actions button:hover { border-color: var(--accent-gold); background: rgba(201,162,39,0.1); }
    .sync-actions button:disabled { opacity: 0.4; cursor: not-allowed; }
    .sync-status-text { font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 0.75rem; }
    .sync-hint { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; }
    .sync-toggle { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; }
    .sync-toggle input { accent-color: var(--accent-gold); }
    .sync-section-label { font-size: 0.8rem; color: var(--accent-gold); margin-bottom: 0.35rem; font-weight: 500; margin-top: 0.75rem; }
    .sync-section-label:first-child { margin-top: 0; }
    .achievement-popup { position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 9000; background: linear-gradient(135deg, rgba(10,10,15,0.95), rgba(30,28,20,0.95)); border: 2px solid var(--accent-gold); border-radius: 12px; padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; backdrop-filter: blur(8px); animation: achPopIn 0.5s ease, achPopOut 0.5s ease 2.5s forwards; box-shadow: 0 4px 20px rgba(201,162,39,0.3); }
    .achievement-popup .ach-pop-icon { font-size: 1.5rem; }
    .achievement-popup .ach-pop-text { font-size: 0.8rem; }
    .achievement-popup .ach-pop-text span { display: block; font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
    @keyframes achPopIn { from { opacity: 0; transform: translateX(-50%) translateY(-2rem); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    @keyframes achPopOut { from { opacity: 1; } to { opacity: 0; transform: translateX(-50%) translateY(-2rem); } }
    .stat-item { display: flex; align-items: center; gap: 0.35rem; }
    .stat-value { color: var(--accent-gold-light); font-weight: 500; }
    .tab-nav { display: flex; background: var(--bg-dark); border-bottom: 1px solid var(--border-subtle); z-index: 100; }
    .tab-btn { flex: 1; padding: 0.75rem 0.5rem; background: none; border: none; color: var(--text-secondary); font-family: 'Noto Sans JP', sans-serif; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; position: relative; }
    .tab-btn:hover { color: var(--text-primary); background: rgba(201, 162, 39, 0.05); }
    .tab-btn.active { color: var(--accent-gold); }
    .tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 2px; background: var(--accent-gold); }
    .tab-btn .notification-dot { position: absolute; top: 0.4rem; right: calc(50% - 1.5rem); width: 6px; height: 6px; background: var(--accent-red-light); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .tab-content { flex: 1; display: none; flex-direction: column; overflow: hidden; }
    .tab-content.active { display: flex; }
    .vn-container { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
    .vn-background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; background-repeat: no-repeat; z-index: 0; transition: opacity 0.5s ease; }
    .vn-background-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(180deg, rgba(10, 10, 15, 0.3) 0%, rgba(10, 10, 15, 0.1) 50%, rgba(10, 10, 15, 0.4) 100%); z-index: 1; pointer-events: none; }
    .vn-character-area { flex: 1; display: flex; justify-content: center; align-items: flex-end; position: relative; z-index: 10; min-height: 200px; }
    .claire-sprite { max-height: 100%; max-width: 90%; object-fit: contain; object-position: bottom center; transition: opacity 0.3s ease, transform 0.3s ease; filter: drop-shadow(0 0 30px rgba(0, 0, 0, 0.5)); }
    .claire-sprite.changing { opacity: 0; transform: scale(0.98); }
    .scene-blackout { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 25; opacity: 0; pointer-events: none; transition: opacity 0.6s ease; }
    .scene-blackout.active { opacity: 1; }
    /* ÁØùÁÅ´ÊºîÂá∫„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .bonfire-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; background: #000; display: none; align-items: center; justify-content: center; }
    .bonfire-overlay.active { display: flex; }
    .bonfire-video { width: 100%; height: 100%; object-fit: cover; }
    .bonfire-skip { position: absolute; bottom: 1.5rem; right: 1.5rem; padding: 0.5rem 1rem; background: rgba(0,0,0,0.6); border: 1px solid rgba(201,162,39,0.5); border-radius: 20px; color: var(--accent-gold); font-family: 'Noto Sans JP', sans-serif; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; z-index: 31; backdrop-filter: blur(4px); }
    .bonfire-skip:hover { background: rgba(201,162,39,0.2); border-color: var(--accent-gold); }
    .claire-sprite.scene-hide { opacity: 0; transform: scale(0.98); transition: opacity 0.5s ease, transform 0.5s ease; }
    .vn-background.scene-hide { opacity: 0; transition: opacity 0.6s ease; }
    .vn-dialogue-area { position: relative; z-index: 20; padding: 0 1rem 1rem 1rem; }
    .speech-bubble { background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(18, 18, 26, 0.95) 100%); border: 2px solid var(--border-subtle); border-radius: 16px; padding: 1rem 1.25rem; position: relative; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(201, 162, 39, 0.1); }
    .speech-bubble::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 12px solid var(--border-subtle); }
    .speech-bubble::after { content: ''; position: absolute; top: -9px; left: 50%; transform: translateX(-50%); border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid rgba(26, 26, 46, 0.95); }
    .speaker-name { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .speaker-name::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, var(--border-subtle) 0%, transparent 100%); }
    .dialogue-text { font-size: 0.95rem; line-height: 1.7; color: var(--text-primary); min-height: 3em; }
    .dialogue-text p { margin-bottom: 0.5rem; }
    .dialogue-text p:last-child { margin-bottom: 0; }
    .typing-indicator { display: flex; gap: 4px; padding: 0.25rem 0; }
    .typing-dot { width: 6px; height: 6px; background: var(--accent-gold); border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce { 0%, 80%, 100% { transform: translateY(0); opacity: 0.4; } 40% { transform: translateY(-4px); opacity: 1; } }
    .quick-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); }
    .quick-action-btn { padding: 0.5rem 1rem; background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 100%); border: 1px solid var(--border-subtle); border-radius: 20px; color: var(--text-primary); font-size: 0.85rem; font-family: 'Noto Sans JP', sans-serif; cursor: pointer; transition: all 0.2s ease; }
    .quick-action-btn:hover { background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%); color: var(--bg-darkest); border-color: var(--accent-gold); transform: translateY(-1px); }
    .vn-input-area { padding: 0.75rem 1rem; background: linear-gradient(180deg, transparent 0%, rgba(18, 18, 26, 0.9) 100%); position: relative; z-index: 20; }
    .input-wrapper { display: flex; gap: 0.5rem; align-items: flex-end; }
    .input-field { flex: 1; padding: 0.75rem 1rem; background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 24px; color: var(--text-primary); font-family: 'Noto Sans JP', sans-serif; font-size: 0.95rem; resize: none; min-height: 44px; max-height: 100px; }
    .input-field:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 15px var(--shadow-glow); }
    .input-field::placeholder { color: var(--text-dim); }
    .send-btn { width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%); border: none; border-radius: 50%; color: var(--bg-darkest); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease; flex-shrink: 0; }
    .send-btn:hover { transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .map-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-darkest); }
    .map-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); }
    .kingdom-name { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--accent-gold); }
    .kingdom-progress { font-size: 0.8rem; color: var(--text-secondary); }
    .map-container { flex: 1; overflow-y: auto; padding: 1rem; }
    .map-placeholder { height: 100%; min-height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-medium); border: 2px dashed var(--border-subtle); border-radius: 12px; color: var(--text-secondary); text-align: center; padding: 2rem; }
    .map-placeholder-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.5; }
    .regions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.75rem; }
    .region-card { background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 0.875rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .region-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--prosperity-low); }
    .region-card.conquered::before { background: var(--prosperity-high); }
    .region-card:hover { border-color: var(--accent-gold); transform: translateY(-2px); }
    .region-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .region-name { font-weight: 500; font-size: 0.9rem; }
    .region-status { font-size: 0.7rem; padding: 0.2rem 0.4rem; border-radius: 4px; background: var(--bg-light); }
    .region-status.conquered { background: var(--prosperity-high); }
    .region-territories { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.5rem; }
    .territory-tag { font-size: 0.7rem; padding: 0.2rem 0.4rem; background: var(--bg-light); border-radius: 3px; color: var(--text-secondary); }
    .territory-tag.conquered { background: rgba(45, 90, 61, 0.3); color: #6abf7b; }
    .region-prosperity { margin-top: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }
    .prosperity-bar { flex: 1; height: 4px; background: var(--bg-light); border-radius: 2px; overflow: hidden; }
    .prosperity-fill { height: 100%; background: linear-gradient(90deg, var(--prosperity-low) 0%, var(--prosperity-medium) 50%, var(--prosperity-high) 100%); border-radius: 2px; transition: width 0.5s ease; }
    .prosperity-value { font-size: 0.75rem; color: var(--accent-gold); min-width: 32px; text-align: right; }
    .quest-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-darkest); }
    .quest-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; background: var(--bg-dark); }
    .quest-header h2 { font-size: 1rem; font-weight: 500; }
    .add-quest-btn { padding: 0.4rem 0.75rem; background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%); border: none; border-radius: 6px; color: var(--bg-darkest); font-size: 0.8rem; font-weight: 500; cursor: pointer; }
    .quest-list { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; color: var(--text-secondary); }
    .empty-state-icon { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }
    .dialogue-quest-list { max-height: 40vh; overflow-y: auto; display: flex; flex-direction: column; gap: 0.4rem; margin-top: 0.5rem; padding-right: 0.25rem; }
    .dialogue-quest-card { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.6rem; background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle); border-radius: 8px; font-size: 0.78rem; transition: border-color 0.2s; }
    .dialogue-quest-card:hover { border-color: var(--accent-gold); }
    .dialogue-quest-card .dqc-icon { font-size: 1rem; opacity: 0.7; }
    .dialogue-quest-card .dqc-body { flex: 1; min-width: 0; }
    .dialogue-quest-card .dqc-title { color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dialogue-quest-card .dqc-meta { color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.15rem; }
    .dialogue-quest-nav { display: flex; justify-content: center; align-items: center; gap: 0.75rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary); }
    .dialogue-quest-nav button { background: none; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); padding: 0.25rem 0.6rem; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
    .dialogue-quest-nav button:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
    .dialogue-quest-nav button:disabled { opacity: 0.3; cursor: default; }
    .dialogue-quest-empty { text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding: 1rem 0; }
    .dialogue-quest-detail { margin-top: 0.5rem; }
    .dqd-title { font-size: 0.95rem; font-weight: 600; color: var(--accent-gold); margin-bottom: 0.75rem; }
    .dqd-row { display: flex; gap: 0.5rem; margin-bottom: 0.4rem; font-size: 0.8rem; }
    .dqd-label { color: var(--text-secondary); min-width: 5rem; flex-shrink: 0; }
    .dqd-value { color: var(--text-primary); }
    .dqd-memo { margin-top: 0.75rem; padding: 0.6rem 0.75rem; background: rgba(255,255,255,0.04); border-left: 2px solid var(--accent-gold); border-radius: 0 6px 6px 0; font-size: 0.8rem; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap; }
    .dqd-no-memo { color: var(--text-secondary); font-style: italic; font-size: 0.78rem; margin-top: 0.75rem; }
    .alert-card { background: linear-gradient(135deg, rgba(139, 41, 66, 0.2) 0%, rgba(139, 41, 66, 0.1) 100%); border: 1px solid var(--accent-red); border-radius: 8px; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .alert-icon { font-size: 1.25rem; }
    .alert-content { flex: 1; }
    .alert-title { font-weight: 500; font-size: 0.9rem; color: var(--accent-red-light); margin-bottom: 0.15rem; }
    .alert-message { font-size: 0.75rem; color: var(--text-secondary); }
    .alert-action { padding: 0.4rem 0.75rem; background: var(--accent-red); border: none; border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 0.8rem; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; backdrop-filter: blur(4px); }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-dark); border: 1px solid var(--border-subtle); border-radius: 12px; width: 100%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
    .modal-header { padding: 1rem; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--accent-gold); }
    .modal-close { width: 28px; height: 28px; background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
    .modal-body { padding: 1rem; }
    .form-group { margin-bottom: 0.875rem; }
    .form-label { display: block; margin-bottom: 0.35rem; font-size: 0.85rem; color: var(--text-secondary); }
    .form-input, .form-select { width: 100%; padding: 0.65rem 0.875rem; background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-family: 'Noto Sans JP', sans-serif; font-size: 0.95rem; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-gold); }
    .modal-footer { padding: 1rem; border-top: 1px solid var(--border-subtle); display: flex; gap: 0.5rem; justify-content: flex-end; }
    .btn-secondary { padding: 0.6rem 1.25rem; background: var(--bg-light); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-family: 'Noto Sans JP', sans-serif; }
    .btn-primary { padding: 0.6rem 1.25rem; background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%); border: none; border-radius: 6px; color: var(--bg-darkest); font-weight: 500; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; }
    .territory-detail-status { background: var(--bg-medium); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .territory-status-row { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid var(--border-subtle); }
    .territory-status-row:last-child { border-bottom: none; }
    .territory-status-label { color: var(--text-secondary); font-size: 0.85rem; }
    .territory-status-value { font-weight: 500; }
    .territory-status-value.conquered { color: #6abf7b; }
    .territory-status-value.unconquered { color: var(--text-dim); }
    .territory-detail-section { margin-bottom: 1rem; }
    .territory-detail-label { font-size: 0.9rem; color: var(--accent-gold); margin-bottom: 0.5rem; font-weight: 500; }
    .territory-history-list { background: var(--bg-medium); border-radius: 8px; max-height: 150px; overflow-y: auto; }
    .territory-history-item { display: flex; justify-content: space-between; padding: 0.6rem 1rem; border-bottom: 1px solid var(--border-subtle); font-size: 0.85rem; }
    .territory-history-item:last-child { border-bottom: none; }
    .territory-history-date { color: var(--text-secondary); }
    .territory-history-score { font-weight: 500; }
    .territory-history-score.high { color: #6abf7b; }
    .territory-history-score.medium { color: var(--accent-gold); }
    .territory-history-score.low { color: var(--accent-red-light); }
    .territory-history-empty { padding: 1rem; text-align: center; color: var(--text-dim); font-size: 0.85rem; }
    .territory-detail-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .td-stat { background: var(--bg-medium); border-radius: 8px; padding: 0.6rem 0.5rem; text-align: center; }
    .td-stat-value { font-size: 1.1rem; font-weight: 600; color: var(--accent-gold); }
    .td-stat-label { font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.15rem; }
    .territory-quest-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-subtle); font-size: 0.82rem; cursor: pointer; transition: background 0.2s; }
    .territory-quest-item:last-child { border-bottom: none; }
    .territory-quest-item:hover { background: rgba(201,162,39,0.08); }
    .tqi-icon { font-size: 0.9rem; flex-shrink: 0; }
    .tqi-body { flex: 1; min-width: 0; }
    .tqi-title { color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tqi-meta { color: var(--text-dim); font-size: 0.72rem; margin-top: 0.1rem; }
    .tqi-arrow { color: var(--text-dim); font-size: 0.7rem; flex-shrink: 0; }
    .territory-test-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-subtle); font-size: 0.82rem; }
    .territory-test-item:last-child { border-bottom: none; }
    .tti-score { font-weight: 600; min-width: 3rem; text-align: right; }
    .tti-date { color: var(--text-secondary); flex-shrink: 0; }
    .tti-note { flex: 1; color: var(--text-dim); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-left: 0.25rem; }
    .territory-detail-actions { display: flex; gap: 0.5rem; padding: 0 1.25rem 1rem; }
    .territory-detail-actions .btn-action { flex: 1; padding: 0.6rem; font-size: 0.82rem; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--bg-medium); color: var(--text-primary); cursor: pointer; transition: all 0.2s; text-align: center; font-family: 'Noto Sans JP', sans-serif; }
    .territory-detail-actions .btn-action:hover { border-color: var(--accent-gold); background: rgba(201,162,39,0.1); }
    .territory-detail-more { text-align: center; padding: 0.4rem; font-size: 0.75rem; color: var(--text-dim); cursor: pointer; }
    .territory-detail-more:hover { color: var(--accent-gold); }
    .territory-memo { resize: vertical; min-height: 80px; }
    .territory-tag { cursor: pointer; transition: all 0.2s ease; }
    .territory-tag:hover { background: var(--accent-gold); color: var(--bg-darkest); }
    .chat-btn { width: 44px; height: 44px; background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 100%); border: 1px solid var(--border-subtle); border-radius: 50%; color: var(--accent-gold); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0; }
    .chat-btn:hover { background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%); color: var(--bg-darkest); border-color: var(--accent-gold); transform: scale(1.05); }
    .chat-menu-modal { max-width: 320px; }
    .chat-menu-body { padding: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
    .chat-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 10px; color: var(--text-primary); font-family: 'Noto Sans JP', sans-serif; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; text-align: left; }
    .chat-menu-item:hover { background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-medium) 100%); border-color: var(--accent-gold); transform: translateX(4px); }
    .chat-menu-icon { font-size: 1.25rem; }
    .chat-menu-label { flex: 1; }
    @media (max-width: 480px) { .header-stats { display: none; } .logo { font-size: 1.1rem; } .tab-btn { font-size: 0.7rem; padding: 0.6rem 0.1rem; } .regions-grid { grid-template-columns: 1fr; } }

    /* === „É¢„Éê„Ç§„É´ÁâàVN„É¨„Ç§„Ç¢„Ç¶„Éà === */
    @media (max-width: 768px) {
      .vn-container { position: relative; }
      .vn-character-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; min-height: unset; z-index: 10; display: flex; justify-content: center; align-items: center; }
      .claire-sprite { max-height: 85%; max-width: 95%; object-position: center; }
      .vn-dialogue-area { position: absolute; bottom: 0; left: 0; right: 0; z-index: 20; padding: 0 0.6rem 0.4rem 0.6rem; max-height: 52%; overflow-y: auto; }
      .speech-bubble { background: linear-gradient(135deg, rgba(16, 16, 30, 0.75) 0%, rgba(12, 12, 20, 0.8) 100%); border: 1px solid rgba(201, 162, 39, 0.25); border-radius: 12px; padding: 0.6rem 0.8rem; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5); }
      .speech-bubble::before, .speech-bubble::after { display: none; }
      .speaker-name { font-size: 0.75rem; margin-bottom: 0.3rem; }
      .dialogue-text { font-size: 0.82rem; line-height: 1.6; min-height: 1.5em; }
      .dialogue-text p { margin-bottom: 0.3rem; }
      .quick-actions { gap: 0.35rem; margin-top: 0.5rem; padding-top: 0.5rem; }
      .quick-action-btn { padding: 0.35rem 0.75rem; font-size: 0.75rem; border-radius: 16px; }
      .vn-input-area { position: absolute; bottom: 0; left: 0; right: 0; z-index: 25; padding: 0.5rem 0.6rem; background: linear-gradient(180deg, transparent 0%, rgba(10, 10, 15, 0.95) 40%); }
      .input-field { padding: 0.6rem 0.8rem; font-size: 0.85rem; min-height: 38px; border-radius: 20px; }
      .send-btn { width: 38px; height: 38px; }
      .chat-btn { width: 38px; height: 38px; }
      /* ÂÖ•Âäõ„Ç®„É™„Ç¢ÂàÜ„ÅÆ„Çπ„Éö„Éº„ÇπÁ¢∫‰øù */
      .vn-dialogue-area { bottom: 52px; }
      /* Êõ∏Á∞°„É™„Çπ„Éà„Éª‰ΩìË™ø„É™„Çπ„Éà„ÅÆ„Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
      .dialogue-quest-card { padding: 0.4rem 0.5rem; font-size: 0.72rem; }
      .dialogue-quest-card .dqc-icon { font-size: 0.85rem; }
      .dialogue-quest-card .dqc-meta { font-size: 0.65rem; }
      /* ‰ΩìË™øÂàÜÊûê„ÅÆ„Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
      .cond-analysis { font-size: 0.78rem; }
      .cond-chart-section { margin-bottom: 0.6rem; padding: 0.5rem; }
      .cond-stat-card { padding: 0.4rem; }
      /* „É¢„Éº„ÉÄ„É´Ë™øÊï¥ */
      .modal-content { margin: 0.5rem; max-height: 90vh; }
      .condition-modal { max-width: 95%; }
      /* „Çø„Ç§„Éû„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
      .timer-time { font-size: 2.5rem; }
    }
    /* ‰ΩìË™øË®òÈå≤„É¢„Éº„ÉÄ„É´ */
    .condition-modal { max-width: 400px; }
    .condition-modal-body { max-height: 60vh; overflow-y: auto; padding: 0.75rem 1.25rem; }
    .cond-section { margin-bottom: 0.85rem; }
    .cond-label { font-size: 0.82rem; color: var(--accent-gold); margin-bottom: 0.4rem; font-weight: 500; }
    .cond-level-group { display: flex; gap: 0.3rem; }
    .cond-level-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.15rem; padding: 0.5rem 0.2rem; background: var(--bg-medium); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.2s; font-family: 'Noto Sans JP', sans-serif; }
    .cond-level-btn:hover { border-color: var(--accent-gold); }
    .cond-level-btn.active { border-color: var(--accent-gold); background: rgba(201,162,39,0.15); box-shadow: 0 0 8px rgba(201,162,39,0.3); }
    .cond-level-emoji { font-size: 1.4rem; }
    .cond-level-text { font-size: 0.65rem; color: var(--text-secondary); }
    .cond-level-btn.active .cond-level-text { color: var(--accent-gold); }
    .cond-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .cond-tag { padding: 0.35rem 0.6rem; background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 20px; cursor: pointer; font-size: 0.75rem; color: var(--text-secondary); transition: all 0.2s; font-family: 'Noto Sans JP', sans-serif; }
    .cond-tag:hover { border-color: var(--text-secondary); }
    .cond-tag.active { border-color: var(--accent-red-light); background: rgba(232,100,100,0.15); color: var(--accent-red-light); }
    .cond-row-group { display: flex; gap: 0.75rem; }
    .cond-row-item { flex: 1; }
    .cond-input-row { display: flex; align-items: center; gap: 0.4rem; }
    .cond-num { width: 100%; max-width: 90px; padding: 0.4rem 0.5rem; font-size: 0.85rem; }
    .cond-unit { font-size: 0.78rem; color: var(--text-secondary); flex-shrink: 0; }
    .cond-meal-group { display: flex; gap: 0.75rem; }
    .cond-meal { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.85rem; color: var(--text-primary); }
    .cond-meal input { accent-color: var(--accent-gold); width: 16px; height: 16px; }
    /* ‰ΩìË™øÂàÜÊûê */
    .cond-analysis { margin-top: 0.5rem; }
    .cond-chart-section { margin-bottom: 1rem; }
    .cond-chart-title { font-size: 0.82rem; color: var(--accent-gold); margin-bottom: 0.4rem; font-weight: 500; }
    .cond-bar-chart { display: flex; align-items: flex-end; gap: 0.35rem; min-height: 80px; padding-top: 0.25rem; }
    .cond-bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.2rem; }
    .cond-bar { width: 100%; border-radius: 3px 3px 0 0; transition: height 0.3s; min-height: 2px; }
    .cond-bar-label { font-size: 0.65rem; color: var(--text-dim); }
    .cond-bar-value { font-size: 0.65rem; color: var(--text-secondary); }
    .cond-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .cond-stat-card { background: var(--bg-medium); border-radius: 8px; padding: 0.5rem 0.6rem; }
    .cond-stat-card-title { font-size: 0.7rem; color: var(--text-dim); }
    .cond-stat-card-value { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-top: 0.15rem; }
    .cond-tag-freq { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; font-size: 0.78rem; }
    .cond-tag-freq-bar { height: 6px; background: var(--accent-red-light); border-radius: 3px; transition: width 0.3s; }
    .cond-tag-freq-name { min-width: 5rem; color: var(--text-secondary); }
    .cond-tag-freq-count { color: var(--text-dim); font-size: 0.7rem; min-width: 2rem; text-align: right; }
    .cond-insight { margin-top: 0.5rem; padding: 0.6rem 0.75rem; background: rgba(201,162,39,0.08); border-left: 2px solid var(--accent-gold); border-radius: 0 6px 6px 0; font-size: 0.78rem; color: var(--text-primary); line-height: 1.6; }
    /* „Çø„Ç§„Éû„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    /* „Çπ„Éó„É©„ÉÉ„Ç∑„É•ÁîªÈù¢ÔºàËµ∑ÂãïÊºîÂá∫Ôºâ */
    .splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; cursor: pointer; background: var(--bg-darkest); }
    .splash-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease; }
    .splash-image.hidden { opacity: 0; }
    .splash-hint { position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); color: var(--text-secondary); font-size: 0.85rem; animation: splashPulse 2s infinite; pointer-events: none; text-shadow: 0 1px 4px rgba(0,0,0,0.8); }
    @keyframes splashPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
    .splash-screen.fade-out { opacity: 0; transition: opacity 0.8s ease; pointer-events: none; }
    /* „Çø„Ç§„Éû„Éº„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .timer-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    .timer-overlay.active { display: flex; }
    .timer-display { background: rgba(10, 10, 15, 0.75); border: 2px solid var(--border-subtle); border-radius: 16px; padding: 1.25rem 2rem; text-align: center; pointer-events: auto; backdrop-filter: blur(8px); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); min-width: 220px; }
    .timer-territory { font-size: 0.8rem; color: var(--accent-gold); margin-bottom: 0.25rem; font-weight: 500; }
    .timer-phase { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .timer-phase.work { color: var(--accent-gold-light); }
    .timer-phase.break { color: #6abf7b; }
    .timer-time { font-family: 'Cinzel', serif; font-size: 3rem; color: var(--text-primary); letter-spacing: 0.1em; line-height: 1; margin-bottom: 0.75rem; }
    .timer-time.break { color: #6abf7b; }
    .timer-controls { display: flex; gap: 0.5rem; justify-content: center; }
    .timer-ctrl-btn { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-subtle); font-family: 'Noto Sans JP', sans-serif; font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease; }
    .timer-ctrl-btn.pause { background: var(--bg-light); color: var(--text-primary); }
    .timer-ctrl-btn.pause:hover { background: var(--accent-gold); color: var(--bg-darkest); border-color: var(--accent-gold); }
    .timer-ctrl-btn.stop { background: rgba(139, 41, 66, 0.3); color: var(--accent-red-light); border-color: var(--accent-red); }
    .timer-ctrl-btn.stop:hover { background: var(--accent-red); color: var(--text-primary); }
    /* Â≠¶ÁøíÈñãÂßã„É¢„Éº„ÉÄ„É´ */
    .study-step { display: none; }
    .study-step.active { display: block; }
    .mode-select-grid { display: flex; flex-direction: column; gap: 0.5rem; }
    .mode-option { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--bg-medium); border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.2s ease; text-align: left; font-family: 'Noto Sans JP', sans-serif; color: var(--text-primary); }
    .mode-option:hover { border-color: var(--accent-gold); transform: translateX(4px); }
    .mode-option.selected { border-color: var(--accent-gold); background: rgba(201, 162, 39, 0.1); }
    .mode-icon { font-size: 1.5rem; }
    .mode-info { flex: 1; }
    .mode-name { font-weight: 500; font-size: 0.95rem; margin-bottom: 0.15rem; }
    .mode-desc { font-size: 0.75rem; color: var(--text-secondary); }
  </style>
</head>
<body>
  <!-- „Çª„É™„Éï„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <script src="dialogues/claire.js"></script>
  
  <!-- „Çπ„Éó„É©„ÉÉ„Ç∑„É•ÁîªÈù¢ÔºàËµ∑ÂãïÊºîÂá∫Ôºâ -->
  <div class="splash-screen" id="splash-screen">
    <img src="" alt="" class="splash-image" id="splash-idle">
    <img src="" alt="" class="splash-image hidden" id="splash-notice">
    <div class="splash-hint" id="splash-hint">„Çø„ÉÉ„Éó„Åó„Å¶Âßã„ÇÅ„Çã</div>
  </div>

  <div class="app-container">
    <header>
      <div class="logo">Re:<span>Kingdom</span></div>
      <div class="header-stats">
        <div class="stat-item streak-display" id="streak-display" style="display:none;"><span>üî•</span><span class="stat-value" id="streak-count">0</span></div>
        <div class="stat-item"><span>üìú</span><span class="stat-value" id="total-quests">0</span></div>
        <div class="stat-item"><span>üè∞</span><span class="stat-value" id="conquered-territories">0</span><span>/<span id="total-territories">0</span></span></div>
        <button class="sync-btn" id="sync-btn" title="„ÇØ„É©„Ç¶„ÉâÂêåÊúü"><span class="sync-icon">‚òÅÔ∏è</span><span class="sync-status-dot" id="sync-status-dot"></span></button>
      </div>
    </header>
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="dialogue">„ÇØ„É¨„Ç¢</button>
      <button class="tab-btn" data-tab="map">ÁéãÂõΩÂú∞Âõ≥</button>
      <button class="tab-btn" data-tab="review">Âæ©Áøí<span class="notification-dot" id="review-notification" style="display: none;"></span></button>
      <button class="tab-btn" data-tab="achievements">ÂÆüÁ∏æ</button>
      <button class="tab-btn" data-tab="items">ÊâÄÊåÅÂìÅ</button>
    </nav>
    <main class="main-content">
      <div class="tab-content active" id="tab-dialogue">
        <div class="vn-container">
          <div class="vn-background" id="vn-background"></div>
          <div class="vn-background-overlay"></div>
          <div class="scene-blackout" id="scene-blackout"></div>
          <div class="bonfire-overlay" id="bonfire-overlay">
            <video class="bonfire-video" id="bonfire-video" playsinline preload="none">
              <source src="images/effects/bonfire_offering.mp4" type="video/mp4">
            </video>
            <button class="bonfire-skip" id="bonfire-skip">„Çπ„Ç≠„ÉÉ„Éó ‚ñ∂‚ñ∂</button>
          </div>
          <div class="timer-overlay" id="timer-overlay">
            <div class="timer-display">
              <div class="timer-territory" id="timer-territory"></div>
              <div class="timer-phase" id="timer-phase"></div>
              <div class="timer-time" id="timer-time">25:00</div>
              <div class="timer-controls">
                <button class="timer-ctrl-btn pause" id="timer-pause">‰∏ÄÊôÇÂÅúÊ≠¢</button>
                <button class="timer-ctrl-btn stop" id="timer-stop">ÁµÇ‰∫Ü</button>
              </div>
            </div>
          </div>
          <div class="vn-character-area">
            <img src="images/chara/claire/normal.png" alt="„ÇØ„É¨„Ç¢" class="claire-sprite" id="claire-sprite">
          </div>
          <div class="vn-dialogue-area">
            <div class="speech-bubble">
              <div class="speaker-name">„ÇØ„É¨„Ç¢</div>
              <div class="dialogue-text" id="dialogue-text">
                <div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
              </div>
              <div class="quick-actions" id="quick-actions"></div>
            </div>
          </div>
          <div class="vn-input-area">
            <div class="input-wrapper">
              <button class="chat-btn" id="chat-btn" title="„ÇØ„É¨„Ç¢„Å®Ë©±„Åô">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
              </button>
              <textarea class="input-field" id="user-input" placeholder="„ÇØ„É¨„Ç¢„Å´Ë©±„Åó„Åã„Åë„Çã..." rows="1"></textarea>
              <button class="send-btn" id="send-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tab-map">
        <div class="map-section">
          <div class="map-header">
            <div class="kingdom-name" id="kingdom-name">ÁéãÂõΩÊú™Ë®≠ÂÆö</div>
            <div class="kingdom-progress" id="kingdom-progress">ÊµÑÂåñÁéá: 0%</div>
          </div>
          <div class="map-container">
            <div id="regions-container" class="regions-grid">
              <div class="map-placeholder">
                <div class="map-placeholder-icon">üó∫Ô∏è</div>
                <p>„Åæ„Å†ÁéãÂõΩ„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                <p style="font-size: 0.8rem; margin-top: 0.4rem; opacity: 0.7;">„ÇØ„É¨„Ç¢„Å´Ë©±„Åó„Åã„Åë„Å¶ÁéãÂõΩ„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tab-review">
        <div class="quest-section">
          <div class="quest-header"><h2>Èúß„ÅåËø´„ÇãÈ†òÂúü</h2></div>
          <div class="quest-list" id="review-list">
            <div class="empty-state"><div class="empty-state-icon">‚ú®</div><p>„Åô„Åπ„Å¶„ÅÆÈ†òÂúü„ÅåÂÆâÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô</p></div>
          </div>
        </div>
      </div>
      <div class="tab-content" id="tab-achievements">
        <div class="achievement-summary">
          <div>Ëß£Èô§Ê∏à„Åø <span class="ach-count" id="ach-unlocked">0</span> / <span id="ach-total">0</span></div>
          <div>üî•ÊúÄÈï∑ÈÄ£Á∂ö <span class="ach-count" id="ach-longest-streak">0</span>Êó•</div>
        </div>
        <div class="achievements-grid" id="achievements-grid"></div>
      </div>
      <div class="tab-content" id="tab-items">
        <div class="items-summary">
          <div>ÊâÄÊåÅ„Ç¢„Ç§„ÉÜ„É† <span class="item-count" id="item-owned">0</span> / <span id="item-total">0</span></div>
        </div>
        <div class="items-grid" id="items-grid"></div>
      </div>
    </main>
  </div>
  <div class="modal-overlay" id="quest-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Êõ∏Á∞°„ÇíÁ∂¥„Çã</h3><button class="modal-close" id="close-quest-modal">&times;</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Êõ∏Á∞°„ÅÆÂÜÖÂÆπ</label><input type="text" class="form-input" id="quest-title" placeholder="‰æãÔºöEC2„ÅÆÂü∫Á§é„Å´„Å§„ÅÑ„Å¶"></div>
        <div class="form-group"><label class="form-label">Èñ¢ÈÄ£„Åô„ÇãÈ†òÂúü</label><select class="form-select" id="quest-territory"><option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option></select></div>
        <div class="form-group"><label class="form-label">Ë®òËø∞ÊôÇÈñìÔºàÂàÜÔºâ</label><input type="number" class="form-input" id="quest-duration" placeholder="30" min="1"></div>
        <div class="form-group"><label class="form-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label><textarea class="form-input" id="quest-memo" placeholder="‰æãÔºöS3„ÅÆ„Éê„Ç±„ÉÉ„Éà„Éù„É™„Ç∑„Éº„Å®IAM„Éù„É™„Ç∑„Éº„ÅÆÈÅï„ÅÑ„ÅåÈáçË¶Å" rows="3" style="resize: vertical;"></textarea></div>
      </div>
      <div class="modal-footer"><button class="btn-secondary" id="cancel-quest">„Ç≠„É£„É≥„Çª„É´</button><button class="btn-primary" id="save-quest">Á∂¥„Çã</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="test-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã</h3><button class="modal-close" id="close-test-modal">&times;</button></div>
      <div class="modal-body">
        <div class="form-group"><label class="form-label">ÂØæË±°„ÅÆÈ†òÂúü</label><select class="form-select" id="test-territory"><option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option></select></div>
        <div class="form-group"><label class="form-label">ÊµÑÂåñÂ∫¶Ôºà%Ôºâ</label><input type="number" class="form-input" id="test-score" placeholder="85" min="0" max="100"></div>
        <div class="form-group"><label class="form-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</label><input type="text" class="form-input" id="test-note" placeholder="‰æãÔºöEBS„ÅÆ„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà„ÅåÂº±„ÅÑ"></div>
      </div>
      <div class="modal-footer"><button class="btn-secondary" id="cancel-test">„Ç≠„É£„É≥„Çª„É´</button><button class="btn-primary" id="save-test">ÁÑö„Åπ„Çã</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="territory-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="territory-modal-title">È†òÂúüË©≥Á¥∞</h3><button class="modal-close" id="close-territory-modal">&times;</button></div>
      <div class="modal-body">
        <div class="territory-detail-status" id="territory-detail-status"></div>
        <div class="territory-detail-stats" id="territory-detail-stats"></div>
        <div class="territory-detail-section">
          <div class="territory-detail-label">üìú Êõ∏Á∞°„ÅÆË®òÈå≤</div>
          <div class="territory-history-list" id="territory-quest-list"></div>
        </div>
        <div class="territory-detail-section">
          <div class="territory-detail-label">üî• ÁåÆÁÅ´„ÅÆË®òÈå≤</div>
          <div class="territory-history-list" id="territory-history-list"></div>
        </div>
        <div class="territory-detail-section">
          <div class="territory-detail-label">üìù „É°„É¢</div>
          <textarea class="form-input territory-memo" id="territory-memo" placeholder="„Åì„ÅÆÈ†òÂúü„Å´„Å§„ÅÑ„Å¶„ÅÆ„É°„É¢..." rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="close-territory-detail">Èñâ„Åò„Çã</button>
        <button class="btn-primary" id="save-territory-memo">„É°„É¢„Çí‰øùÂ≠ò</button>
      </div>
      <div class="territory-detail-actions" id="territory-detail-actions"></div>
    </div>
  </div>
  <div class="modal-overlay" id="chat-menu-modal">
    <div class="modal chat-menu-modal">
      <div class="modal-header"><h3 class="modal-title">„ÇØ„É¨„Ç¢„Å®Ë©±„Åô</h3><button class="modal-close" id="close-chat-menu">&times;</button></div>
      <div class="modal-body chat-menu-body">
        <button class="chat-menu-item" data-chat-type="encourage"><span class="chat-menu-icon">üí™</span><span class="chat-menu-label">Âä±„Åæ„Åó„Å¶„ÇÇ„Çâ„ÅÜ</span></button>
        <button class="chat-menu-item" data-chat-type="comfort"><span class="chat-menu-icon">üôè</span><span class="chat-menu-label">Âä¥„Å£„Å¶„ÇÇ„Çâ„ÅÜ</span></button>
        <button class="chat-menu-item" data-chat-type="appreciate"><span class="chat-menu-icon">‚ú®</span><span class="chat-menu-label">„ÇØ„É¨„Ç¢„ÇíÂä¥„ÅÜ</span></button>
        <button class="chat-menu-item" data-chat-type="advice"><span class="chat-menu-icon">üìñ</span><span class="chat-menu-label">Â≠¶Áøí„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ</span></button>
        <button class="chat-menu-item" data-chat-type="chat"><span class="chat-menu-icon">üí¨</span><span class="chat-menu-label">ÈõëË´á„Åô„Çã</span></button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="condition-modal">
    <div class="modal condition-modal">
      <div class="modal-header"><h3 class="modal-title">‰ΩìË™ø„ÅÆÂ†±Âëä</h3><button class="modal-close" id="close-condition-modal">&times;</button></div>
      <div class="modal-body condition-modal-body">
        <div class="cond-section">
          <div class="cond-label">‰ªä„ÅÆ‰ΩìË™ø„ÅØÔºü</div>
          <div class="cond-level-group" id="cond-level-group">
            <button class="cond-level-btn" data-level="1"><span class="cond-level-emoji">üòµ</span><span class="cond-level-text">ÊúÄÊÇ™</span></button>
            <button class="cond-level-btn" data-level="2"><span class="cond-level-emoji">üòî</span><span class="cond-level-text">ÊÇ™„ÅÑ</span></button>
            <button class="cond-level-btn" data-level="3"><span class="cond-level-emoji">üòê</span><span class="cond-level-text">ÊôÆÈÄö</span></button>
            <button class="cond-level-btn" data-level="4"><span class="cond-level-emoji">üòä</span><span class="cond-level-text">ËâØ„ÅÑ</span></button>
            <button class="cond-level-btn" data-level="5"><span class="cond-level-emoji">üòÑ</span><span class="cond-level-text">Áµ∂Â•ΩË™ø</span></button>
          </div>
        </div>
        <div class="cond-section">
          <div class="cond-label">ÁóáÁä∂„Çø„Ç∞ÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ</div>
          <div class="cond-tags" id="cond-tags">
            <button class="cond-tag" data-tag="headache">ü§ï È†≠Áóõ</button>
            <button class="cond-tag" data-tag="sleepy">üò™ Áú†Ê∞ó</button>
            <button class="cond-tag" data-tag="stiff">üí™ ËÇ©„Åì„Çä</button>
            <button class="cond-tag" data-tag="eyestrain">üëÅÔ∏è ÁõÆ„ÅÆÁñ≤„Çå</button>
            <button class="cond-tag" data-tag="fatigue">ü•± „Å†„Çã„Åï</button>
            <button class="cond-tag" data-tag="stomach">ü§¢ ËÉÉËÖ∏„ÅÆ‰∏çË™ø</button>
            <button class="cond-tag" data-tag="stress">üò∞ „Çπ„Éà„É¨„Çπ</button>
            <button class="cond-tag" data-tag="unfocused">üåÄ ÈõÜ‰∏≠Âäõ‰Ωé‰∏ã</button>
          </div>
        </div>
        <div class="cond-section cond-row-group">
          <div class="cond-row-item">
            <div class="cond-label">Áù°Áú†ÊôÇÈñì</div>
            <div class="cond-input-row"><input type="number" class="form-input cond-num" id="cond-sleep" placeholder="7" min="0" max="24" step="0.5"><span class="cond-unit">ÊôÇÈñì</span></div>
          </div>
          <div class="cond-row-item">
            <div class="cond-label">„Ç´„Éï„Çß„Ç§„É≥</div>
            <div class="cond-input-row"><input type="number" class="form-input cond-num" id="cond-caffeine" placeholder="2" min="0" max="20"><span class="cond-unit">ÊùØ</span></div>
          </div>
        </div>
        <div class="cond-section">
          <div class="cond-label">È£ü‰∫ã</div>
          <div class="cond-meal-group" id="cond-meals">
            <label class="cond-meal"><input type="checkbox" id="cond-meal-b" value="breakfast"><span>ÊúùÈ£ü</span></label>
            <label class="cond-meal"><input type="checkbox" id="cond-meal-l" value="lunch"><span>ÊòºÈ£ü</span></label>
            <label class="cond-meal"><input type="checkbox" id="cond-meal-d" value="dinner"><span>Â§ïÈ£ü</span></label>
          </div>
        </div>
        <div class="cond-section cond-row-group">
          <div class="cond-row-item">
            <div class="cond-label">Ê∞óÊ∏©</div>
            <div class="cond-input-row"><input type="number" class="form-input cond-num" id="cond-temp" placeholder="20" step="0.1"><span class="cond-unit">‚ÑÉ</span></div>
          </div>
          <div class="cond-row-item">
            <div class="cond-label">Ê∞óÂúß</div>
            <div class="cond-input-row"><input type="number" class="form-input cond-num" id="cond-pressure" placeholder="1013" step="0.1"><span class="cond-unit">hPa</span></div>
          </div>
        </div>
        <div class="cond-section">
          <div class="cond-label">„É°„É¢Ôºà‰ªªÊÑèÔºâ</div>
          <input type="text" class="form-input" id="cond-note" placeholder="‰æãÔºöËñ¨„ÇíÈ£≤„Çì„Å†„ÄÅÈÅãÂãï„Åó„Åü">
        </div>
      </div>
      <div class="modal-footer"><button class="btn-secondary" id="cancel-condition">„Ç≠„É£„É≥„Çª„É´</button><button class="btn-primary" id="save-condition">Â†±Âëä„Åô„Çã</button></div>
    </div>
  </div>
  <div class="modal-overlay" id="item-detail-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="item-modal-title">„Ç¢„Ç§„ÉÜ„É†Ë©≥Á¥∞</h3><button class="modal-close" id="close-item-modal">&times;</button></div>
      <div class="modal-body">
        <div class="item-detail-icon" id="item-detail-icon"></div>
        <div class="item-detail-name" id="item-detail-name"></div>
        <div class="item-detail-type" id="item-detail-type"></div>
        <div class="item-detail-desc" id="item-detail-desc"></div>
        <div class="item-detail-lore" id="item-detail-lore"></div>
        <div class="item-detail-date" id="item-detail-date"></div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="sync-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÂêåÊúü</h3><button class="modal-close" id="close-sync-modal">&times;</button></div>
      <div class="modal-body">
        <div class="sync-section-label">Êé•Á∂öÁä∂ÊÖã</div>
        <div class="sync-status-text" id="sync-connection-status">Êú™Êé•Á∂ö</div>

        <div class="sync-section-label">FirebaseË®≠ÂÆöÔºàJSONÔºâ</div>
        <textarea class="sync-config-area" id="sync-config-input" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."}'></textarea>
        <div class="sync-hint">‚Äª Firebase„Ç≥„É≥„ÇΩ„Éº„É´„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Åã„Çâ„Ç≥„Éî„Éº</div>

        <div class="sync-section-label">ÂêåÊúüID</div>
        <input type="text" class="sync-id-input" id="sync-id-input" placeholder="‰æã: hayato-rekingdom">
        <div class="sync-hint">‚Äª ‰∏°Êñπ„ÅÆÁ´ØÊú´„ÅßÂêå„ÅòID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>

        <div class="sync-actions">
          <button id="sync-test-btn">Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
          <button id="sync-save-config-btn">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
        </div>

        <div class="sync-section-label">ÂêåÊúüÊìç‰Ωú</div>
        <div class="sync-actions">
          <button id="sync-upload-btn" disabled>‚òÅÔ∏è‚Üë „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
          <button id="sync-download-btn" disabled>‚òÅÔ∏è‚Üì „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
        </div>

        <label class="sync-toggle"><input type="checkbox" id="sync-auto-toggle"> Ëá™ÂãïÂêåÊúüÔºà‰øùÂ≠òÊôÇ„Å´Ëá™Âãï„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºâ</label>

        <div class="sync-status-text" id="sync-last-sync">ÊúÄÁµÇÂêåÊúü: „Å™„Åó</div>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="study-modal">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title" id="study-modal-title">Êõ∏Á∞°„ÅÆÂØæË±°„ÇíÈÅ∏Êäû</h3><button class="modal-close" id="close-study-modal">&times;</button></div>
      <div class="modal-body">
        <div class="study-step active" id="study-step-territory">
          <div class="form-group">
            <label class="form-label">Êõ∏Á∞°„ÅÆÂØæË±°È†òÂúü</label>
            <select class="form-select" id="study-territory"><option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option></select>
          </div>
        </div>
        <div class="study-step" id="study-step-mode">
          <div class="mode-select-grid">
            <button class="mode-option" data-mode="pomodoro">
              <span class="mode-icon">üçÖ</span>
              <div class="mode-info"><div class="mode-name">„Éù„É¢„Éâ„Éº„É≠</div><div class="mode-desc">25ÂàÜÈõÜ‰∏≠Ôºã5ÂàÜ‰ºëÊÜ©</div></div>
            </button>
            <button class="mode-option" data-mode="free">
              <span class="mode-icon">‚è±Ô∏è</span>
              <div class="mode-info"><div class="mode-name">ÊôÇÈñìÁÑ°Âà∂Èôê</div><div class="mode-desc">Ëá™ÂàÜ„ÅÆ„Éö„Éº„Çπ„ÅßÁ∂¥„Çã</div></div>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="cancel-study">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-primary" id="study-next" style="display:none;">Ê¨°„Å∏</button>
      </div>
    </div>
  </div>
  <script>
    const AppState = { kingdom: null, regions: [], territories: [], quests: [], testHistory: [], territoryMemos: {}, conditionLogs: [], currentExpression: 'normal', currentTerritoryId: null, streak: { current: 0, longest: 0, lastStudyDate: null, titles: [] }, achievements: {}, items: {} };
    
    // Â§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË°®ÊÉÖ„Å®„Çª„É™„Éï„ÇíÂèÇÁÖß
    const CLAIRE_EXPRESSIONS = CLAIRE_DIALOGUES.expressions;
    const CLAIRE_CONVERSATIONS = CLAIRE_DIALOGUES.conversations;
    const CLAIRE_SYSTEM = CLAIRE_DIALOGUES.system;
    const CLAIRE_EVENTS = CLAIRE_DIALOGUES.events;
    const CLAIRE_TIMER_ENCOURAGEMENT = CLAIRE_DIALOGUES.timerEncouragement;
    const CLAIRE_TIMER_PAUSED = CLAIRE_DIALOGUES.timerPaused;
    const CLAIRE_TIMER_RESUMED = CLAIRE_DIALOGUES.timerResumed;

    // „Çø„Ç§„Éû„ÉºÁä∂ÊÖã
    const TimerState = {
      active: false,
      paused: false,
      mode: null,       // 'pomodoro' or 'free'
      phase: null,       // 'work' or 'break'
      territoryId: null,
      territoryName: '',
      remaining: 0,
      elapsed: 0,
      intervalId: null,
      totalStudyMinutes: 0
    };

    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞„ÇíÂ±ïÈñã„Åô„Çã„Éò„É´„Éë„Éº
    function expandTemplate(template, vars = {}) {
      const result = { text: template.text, expression: template.expression };
      if (template.actions) result.actions = template.actions;
      Object.entries(vars).forEach(([key, value]) => {
        result.text = result.text.replace(new RegExp('\\{' + key + '\\}', 'g'), value);
      });
      return result;
    }
    
    const elements = {
      claireSprite: document.getElementById('claire-sprite'),
      dialogueText: document.getElementById('dialogue-text'),
      quickActions: document.getElementById('quick-actions'),
      userInput: document.getElementById('user-input'),
      sendBtn: document.getElementById('send-btn'),
      regionsContainer: document.getElementById('regions-container'),
      kingdomName: document.getElementById('kingdom-name'),
      kingdomProgress: document.getElementById('kingdom-progress'),
      reviewList: document.getElementById('review-list'),
      totalQuests: document.getElementById('total-quests'),
      conqueredTerritories: document.getElementById('conquered-territories'),
      totalTerritories: document.getElementById('total-territories'),
      questModal: document.getElementById('quest-modal'),
      testModal: document.getElementById('test-modal'),
      reviewNotification: document.getElementById('review-notification'),
      vnBackground: document.getElementById('vn-background'),
      territoryModal: document.getElementById('territory-modal'),
      territoryModalTitle: document.getElementById('territory-modal-title'),
      territoryDetailStatus: document.getElementById('territory-detail-status'),
      territoryHistoryList: document.getElementById('territory-history-list'),
      territoryQuestList: document.getElementById('territory-quest-list'),
      territoryDetailStats: document.getElementById('territory-detail-stats'),
      territoryDetailActions: document.getElementById('territory-detail-actions'),
      territoryMemo: document.getElementById('territory-memo'),
      chatMenuModal: document.getElementById('chat-menu-modal'),
      studyModal: document.getElementById('study-modal'),
      studyModalTitle: document.getElementById('study-modal-title'),
      studyTerritory: document.getElementById('study-territory'),
      studyNext: document.getElementById('study-next'),
      studyStepTerritory: document.getElementById('study-step-territory'),
      studyStepMode: document.getElementById('study-step-mode'),
      timerOverlay: document.getElementById('timer-overlay'),
      timerTerritory: document.getElementById('timer-territory'),
      timerPhase: document.getElementById('timer-phase'),
      timerTime: document.getElementById('timer-time'),
      timerPause: document.getElementById('timer-pause'),
      timerStop: document.getElementById('timer-stop'),
      streakDisplay: document.getElementById('streak-display'),
      streakCount: document.getElementById('streak-count')
    };

    const BACKGROUNDS = {
      day: 'images/bg/day.png',
      evening: 'images/bg/evening.png',
      night: 'images/bg/night.png',
      altar: 'images/bg/altar.png',
      library_day: 'images/bg/library_day.png',
      library_evening: 'images/bg/library_evening.png',
      library_night: 'images/bg/library_night.png'
    };

    function init() {
      loadState();
      setupEventListeners();
      setupTabNavigation();
      setTimeBasedBackground();
      processStreakOnInit();
      // ÂàùÂõûËµ∑ÂãïÊôÇÔºöË®òÊÜ∂„ÅÆÁÅØÁ≠Ü„ÇíËá™ÂãïÂÖ•Êâã
      grantItem('memory_pen');
      updateUI();
      checkReviewAlerts();
      // Ëµ∑ÂãïÊôÇ„Å´Êó¢Â≠ò„Éá„Éº„Çø„ÅßËß£Èô§ÂèØËÉΩ„Å™ÂÆüÁ∏æ„Çí„Çµ„Ç§„É¨„É≥„Éà„ÉÅ„Çß„ÉÉ„ÇØ
      ACHIEVEMENTS.forEach(ach => { if (!AppState.achievements[ach.id] && ach.check()) { AppState.achievements[ach.id] = { unlockedAt: new Date().toISOString() }; } });
      saveState(); renderAchievements();
      // „ÇØ„É©„Ç¶„ÉâÂêåÊúü„ÅÆËá™ÂãïÊé•Á∂ö
      SyncManager.autoConnect();
      setupSplashScreen();
    }

    function setupSplashScreen() {
      const splash = document.getElementById('splash-screen');
      const idleImg = document.getElementById('splash-idle');
      const noticeImg = document.getElementById('splash-notice');
      const hint = document.getElementById('splash-hint');
      let clicked = false;

      // ÊôÇÈñìÂ∏Ø„Å´Âøú„Åò„Åü„Çπ„Éó„É©„ÉÉ„Ç∑„É•ÁîªÂÉè„ÇíÈÅ∏ÊäûÔºàJSTÂü∫Ê∫ñ„ÄÅËÉåÊôØ„Å®Áµ±‰∏ÄÔºâ
      const now = new Date();
      const jstTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const hour = jstTime.getHours();
      const prefix = 'images/chara/claire/idle_desk';
      let suffix = '';
      if (hour >= 15 && hour < 18) suffix = '_evening';
      else if (hour >= 18 || hour < 6) suffix = '_night';
      idleImg.src = prefix + suffix + '.png';
      noticeImg.src = prefix + '_notice' + suffix + '.png';

      splash.addEventListener('click', () => {
        if (clicked) return;
        clicked = true;
        hint.style.display = 'none';
        // Â∑ÆÂàÜ„Å´Âàá„ÇäÊõø„Åà
        idleImg.classList.add('hidden');
        noticeImg.classList.remove('hidden');
        // 1ÁßíÂæå„Å´„É°„Ç§„É≥ÁîªÈù¢„Å∏ÈÅ∑Áßª
        setTimeout(() => {
          splash.classList.add('fade-out');
          setTimeout(() => {
            splash.style.display = 'none';
            const g = getInitialGreeting();
            showDialogue(g.text, g.expression, g.actions);
          }, 800);
        }, 1000);
      });
    }

    function setTimeBasedBackground() {
      const now = new Date();
      const jstTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const hour = jstTime.getHours();
      let bgKey;
      if (hour >= 6 && hour < 15) {
        bgKey = 'day';
      } else if (hour >= 15 && hour < 18) {
        bgKey = 'evening';
      } else {
        bgKey = 'night';
      }
      elements.vnBackground.style.backgroundImage = 'url(' + BACKGROUNDS[bgKey] + ')';
    }

    function setAltarBackground() {
      elements.vnBackground.style.backgroundImage = 'url(' + BACKGROUNDS.altar + ')';
    }

    function setLibraryBackground() {
      const now = new Date();
      const jstTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const hour = jstTime.getHours();
      let bgKey;
      if (hour >= 6 && hour < 15) { bgKey = 'library_day'; }
      else if (hour >= 15 && hour < 18) { bgKey = 'library_evening'; }
      else { bgKey = 'library_night'; }
      elements.vnBackground.style.backgroundImage = 'url(' + BACKGROUNDS[bgKey] + ')';
    }

    function restoreBackground() {
      setTimeBasedBackground();
    }

    function playLibraryTransition(callback) {
      const blackout = document.getElementById('scene-blackout');
      const sprite = elements.claireSprite;
      const bg = elements.vnBackground;

      // „Çª„É™„Éï„Éª„Éú„Çø„É≥„ÇíÊ∂à„Åô
      elements.dialogueText.innerHTML = '';
      elements.quickActions.innerHTML = '';

      // Step 1: „ÇØ„É¨„Ç¢„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà (0.5s)
      sprite.classList.add('scene-hide');

      setTimeout(() => {
        // Step 2: ÊöóËª¢ÈñãÂßã (0.6s)
        blackout.classList.add('active');

        setTimeout(() => {
          // Step 3: ÊöóËª¢‰∏≠„Å´ËÉåÊôØ„ÇíÂõ≥Êõ∏ÂÆ§„Å´Â∑Æ„ÅóÊõø„Åà
          setLibraryBackground();

          setTimeout(() => {
            // Step 4: ÊöóËª¢Ëß£Èô§ (0.6s)
            blackout.classList.remove('active');

            setTimeout(() => {
              // Step 5: „ÇØ„É¨„Ç¢„Éï„Çß„Éº„Éâ„Ç§„É≥
              sprite.classList.remove('scene-hide');

              setTimeout(() => {
                // Step 6: ÂÆå‰∫Ü„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
                if (callback) callback();
              }, 500);
            }, 300);
          }, 1000);
        }, 600);
      }, 500);
    }

    function getStudySpriteUrl() {
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const hour = jst.getHours();
      if (hour >= 6 && hour < 15) return 'images/chara/claire/study.png';
      if (hour >= 15 && hour < 18) return 'images/chara/claire/study_evening.png';
      return 'images/chara/claire/study_night.png';
    }

    function setExpression(expression) {
      const sprite = elements.claireSprite;
      // „Çø„Ç§„Éû„ÉºÁ®ºÂÉç‰∏≠„ÅØÂ≠¶Áøí„Çπ„Éó„É©„Ç§„Éà„Çí‰ΩøÁî®
      if (TimerState.active) {
        const studyUrl = getStudySpriteUrl();
        if (sprite.src.endsWith(studyUrl)) return;
        sprite.classList.add('changing');
        setTimeout(() => {
          sprite.src = studyUrl;
          AppState.currentExpression = '__study__';
          setTimeout(() => sprite.classList.remove('changing'), 50);
        }, 150);
        return;
      }
      if (AppState.currentExpression === expression) return;
      sprite.classList.add('changing');
      setTimeout(() => {
        sprite.src = CLAIRE_EXPRESSIONS[expression] || CLAIRE_EXPRESSIONS.normal;
        AppState.currentExpression = expression;
        setTimeout(() => sprite.classList.remove('changing'), 50);
      }, 150);
    }

    function showDialogue(text, expression = 'normal', actions = []) {
      setExpression(expression);
      elements.dialogueText.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
      elements.quickActions.innerHTML = '';
      setTimeout(() => {
        const paragraphs = text.split('\n').filter(p => p.trim());
        elements.dialogueText.innerHTML = paragraphs.map(p => '<p>' + p + '</p>').join('');
        if (actions && actions.length > 0) {
          elements.quickActions.innerHTML = actions.map(a => '<button class="quick-action-btn" data-value="' + a.value + '">' + a.label + '</button>').join('');
          elements.quickActions.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', () => { if (btn.dataset.value) { elements.userInput.value = btn.dataset.value; handleSendMessage(); } });
          });
        }
      }, 600);
    }

    // === Êõ∏Á∞°„É™„Çπ„ÉàË°®Á§∫Ôºà„ÇØ„É¨„Ç¢„ÅÆ„Çª„É™„ÉïÊ¨ÑÂÜÖÔºâ ===

    const QUEST_PAGE_SIZE = 5;

    function showQuestListInDialogue(page) {
      page = page || 0;
      window._questListPage = page;
      setExpression('normal');
      elements.quickActions.innerHTML = '';

      const quests = AppState.quests.slice().sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
      const totalPages = Math.max(1, Math.ceil(quests.length / QUEST_PAGE_SIZE));
      if (page >= totalPages) page = totalPages - 1;
      if (page < 0) page = 0;

      const headerText = quests.length === 0
        ? '<p>„Åì„Çå„Åæ„Åß„Å´Á∂¥„Çâ„Çå„ÅüÊõ∏Á∞°„ÅØ„Åæ„Å†„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>'
        : '<p>„Åì„Çå„Åæ„Åß„Å´Á∂¥„Çâ„Çå„ÅüÊõ∏Á∞°„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÔºàÂÖ®' + quests.length + 'ÈÄöÔºâ</p>';

      let listHtml;
      if (quests.length === 0) {
        listHtml = '<div class="dialogue-quest-empty">üìú „Åæ„Å†Êõ∏Á∞°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:0.7rem;">Êõ∏Á∞°„ÇíÁ∂¥„Å£„Åü„Çä„ÄÅÊâãÂãïÁôªÈå≤„Åô„Çã„Å®Êõ∏Á∞°„ÅåÂ¢ó„Åà„Å¶„ÅÑ„Åç„Åæ„Åô</span></div>';
      } else {
        const pageQuests = quests.slice(page * QUEST_PAGE_SIZE, (page + 1) * QUEST_PAGE_SIZE);
        listHtml = '<div class="dialogue-quest-list">' + pageQuests.map(q => {
          const territory = AppState.territories.find(t => t.id === q.territoryId);
          const tName = territory ? territory.name : '‚Äî';
          const dateStr = new Date(q.completedAt).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
          const durStr = q.duration ? q.duration + 'ÂàÜ' : '';
          const hasMemo = q.memo ? ' style="cursor:pointer;"' : ' style="cursor:pointer;"';
          return '<div class="dialogue-quest-card" data-quest-id="' + q.id + '">' +
            '<div class="dqc-icon">üìú</div>' +
            '<div class="dqc-body">' +
              '<div class="dqc-title">' + q.title + '</div>' +
              '<div class="dqc-meta">' + tName + '„ÄÄ' + dateStr + (durStr ? '„ÄÄ' + durStr : '') + '</div>' +
            '</div>' +
            '<div class="dqc-icon" style="opacity:0.3;font-size:0.8rem;">‚ñ∂</div>' +
          '</div>';
        }).join('') + '</div>';

        if (totalPages > 1) {
          listHtml += '<div class="dialogue-quest-nav">' +
            '<button id="quest-page-prev" ' + (page <= 0 ? 'disabled' : '') + '>‚óÄ Ââç</button>' +
            '<span>' + (page + 1) + ' / ' + totalPages + '</span>' +
            '<button id="quest-page-next" ' + (page >= totalPages - 1 ? 'disabled' : '') + '>Ê¨° ‚ñ∂</button>' +
          '</div>';
        }
      }

      elements.dialogueText.innerHTML = headerText + listHtml;

      // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
      document.querySelectorAll('.dialogue-quest-card[data-quest-id]').forEach(card => {
        card.addEventListener('click', () => showQuestDetailInDialogue(card.dataset.questId));
      });

      // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅÆ„Ç§„Éô„É≥„Éà
      const prevBtn = document.getElementById('quest-page-prev');
      const nextBtn = document.getElementById('quest-page-next');
      if (prevBtn) prevBtn.addEventListener('click', () => showQuestListInDialogue(page - 1));
      if (nextBtn) nextBtn.addEventListener('click', () => showQuestListInDialogue(page + 1));

      // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
      const actions = [
        { label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' },
        { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
      ];
      elements.quickActions.innerHTML = actions.map(a => '<button class="quick-action-btn" data-value="' + a.value + '">' + a.label + '</button>').join('');
      elements.quickActions.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => { if (btn.dataset.value) { elements.userInput.value = btn.dataset.value; handleSendMessage(); } });
      });
    }

    function showQuestDetailInDialogue(questId) {
      const quest = AppState.quests.find(q => q.id === questId);
      if (!quest) return;
      setExpression('normal');
      elements.quickActions.innerHTML = '';

      const territory = AppState.territories.find(t => t.id === quest.territoryId);
      const tName = territory ? territory.name : 'Êú™ÊåáÂÆö';
      const dateStr = new Date(quest.completedAt).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
      const timeStr = new Date(quest.completedAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      const durStr = quest.duration ? quest.duration + 'ÂàÜ' : '‚Äî';

      let detailHtml = '<div class="dialogue-quest-detail">' +
        '<div class="dqd-title">üìú ' + quest.title + '</div>' +
        '<div class="dqd-row"><span class="dqd-label">È†òÂúü</span><span class="dqd-value">' + tName + '</span></div>' +
        '<div class="dqd-row"><span class="dqd-label">Ë®òËø∞ÊôÇÈñì</span><span class="dqd-value">' + durStr + '</span></div>' +
        '<div class="dqd-row"><span class="dqd-label">Êó•ÊôÇ</span><span class="dqd-value">' + dateStr + ' ' + timeStr + '</span></div>';

      if (quest.memo) {
        detailHtml += '<div class="dqd-memo">' + quest.memo.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>';
      } else {
        detailHtml += '<div class="dqd-no-memo">„É°„É¢„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      }

      detailHtml += '</div>';

      elements.dialogueText.innerHTML = '<p>„Åì„ÅÆÊõ∏Á∞°„ÅÆË©≥Á¥∞„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ</p>' + detailHtml;

      // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
      const actions = [
        { label: '‚óÄ Êõ∏Á∞°‰∏ÄË¶ß„Å´Êàª„Çã', value: '__QUEST_LIST_BACK__' },
        { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
      ];
      elements.quickActions.innerHTML = actions.map(a => '<button class="quick-action-btn" data-value="' + a.value + '">' + a.label + '</button>').join('');
      elements.quickActions.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.value === '__QUEST_LIST_BACK__') {
            showQuestListInDialogue(window._questListPage || 0);
          } else if (btn.dataset.value) {
            elements.userInput.value = btn.dataset.value;
            handleSendMessage();
          }
        });
      });
    }

    function getDailyLine() {
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const dayKey = dayNames[jst.getDay()];
      const lines = CLAIRE_DIALOGUES.dailyGreetings[dayKey] || [];
      // Êó•‰ªò„Ç∑„Éº„Éâ„ÅßÂêå„ÅòÊó•„ÅØÂêå„Åò„Çª„É™„Éï
      const dateSeed = jst.getFullYear() * 10000 + (jst.getMonth() + 1) * 100 + jst.getDate();
      return lines.length > 0 ? lines[dateSeed % lines.length] : '';
    }

    function getStreakDailyLine() {
      const streak = AppState.streak.current || 0;
      const entries = CLAIRE_DIALOGUES.streakDailyLines || [];
      const match = entries.find(e => streak >= e.min && streak <= e.max);
      if (!match) return '';
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      const dateSeed = jst.getFullYear() * 10000 + (jst.getMonth() + 1) * 100 + jst.getDate();
      return match.lines[dateSeed % match.lines.length];
    }

    function getInitialGreeting() {
      if (!AppState.kingdom) {
        return expandTemplate(CLAIRE_SYSTEM.firstGreeting);
      }
      const streakStatus = checkStreakStatus();
      // „Çπ„Éà„É™„Éº„ÇØ„ÅåÈÄîÂàá„Çå„ÅüÂ†¥ÂêàÔºàÂâçÂõû2Êó•‰ª•‰∏ä„ÅÆÈÄ£Á∂ö„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÔºâ
      if (streakStatus === 'broken' && AppState.streak.longest >= 2) {
        const base = expandTemplate(CLAIRE_EVENTS.streakBroken);
        const daily = getDailyLine();
        if (daily) { base.text = base.text + '\n\n' + daily; }
        return base;
      }
      // „Çπ„Éà„É™„Éº„ÇØÁ∂ôÁ∂ö‰∏≠ÔºàÊò®Êó•„ÇÇÂ≠¶Áøí„Åó„ÅüÔºâ
      if (streakStatus === 'continued' && AppState.streak.current >= 2) {
        const base = expandTemplate(CLAIRE_EVENTS.streakContinued, { streak: AppState.streak.current, kingdomName: AppState.kingdom.name, progress: calculateProgress() });
        const streakLine = getStreakDailyLine();
        const daily = streakLine || getDailyLine();
        if (daily) { base.text = base.text + '\n\n' + daily; }
        return base;
      }
      const base = expandTemplate(CLAIRE_SYSTEM.normalGreeting, { kingdomName: AppState.kingdom.name, progress: calculateProgress() });
      const daily = getDailyLine();
      if (daily) { base.text = base.text + '\n\n' + daily; }
      return base;
    }

    function setupEventListeners() {
      elements.sendBtn.addEventListener('click', handleSendMessage);
      elements.userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
      elements.userInput.addEventListener('input', () => { elements.userInput.style.height = 'auto'; elements.userInput.style.height = Math.min(elements.userInput.scrollHeight, 100) + 'px'; });
      document.getElementById('close-quest-modal').addEventListener('click', () => closeModalAndRestore('quest-modal'));
      document.getElementById('cancel-quest').addEventListener('click', () => closeModalAndRestore('quest-modal'));
      document.getElementById('save-quest').addEventListener('click', saveQuest);
      document.getElementById('close-test-modal').addEventListener('click', () => closeModalAndRestore('test-modal'));
      document.getElementById('cancel-test').addEventListener('click', () => closeModalAndRestore('test-modal'));
      document.getElementById('save-test').addEventListener('click', saveTestResult);
      document.getElementById('close-territory-modal').addEventListener('click', () => elements.territoryModal.classList.remove('active'));
      document.getElementById('close-territory-detail').addEventListener('click', () => elements.territoryModal.classList.remove('active'));
      document.getElementById('save-territory-memo').addEventListener('click', saveTerritoryMemo);
      // ‰ºöË©±„É°„Éã„É•„Éº
      document.getElementById('chat-btn').addEventListener('click', () => elements.chatMenuModal.classList.add('active'));
      document.getElementById('close-chat-menu').addEventListener('click', () => elements.chatMenuModal.classList.remove('active'));
      document.getElementById('close-item-modal').addEventListener('click', () => document.getElementById('item-detail-modal').classList.remove('active'));

      // ‰ΩìË™ø„É¢„Éº„ÉÄ„É´
      document.getElementById('close-condition-modal').addEventListener('click', () => document.getElementById('condition-modal').classList.remove('active'));
      document.getElementById('cancel-condition').addEventListener('click', () => document.getElementById('condition-modal').classList.remove('active'));
      document.getElementById('save-condition').addEventListener('click', saveCondition);
      document.querySelectorAll('.cond-level-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.cond-level-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      document.querySelectorAll('.cond-tag').forEach(btn => {
        btn.addEventListener('click', () => btn.classList.toggle('active'));
      });

      // ÂêåÊúü„É¢„Éº„ÉÄ„É´
      document.getElementById('sync-btn').addEventListener('click', () => {
        const cfg = SyncManager.loadConfig();
        if (cfg) {
          document.getElementById('sync-config-input').value = cfg.firebaseConfig || '';
          document.getElementById('sync-id-input').value = cfg.syncId || '';
          document.getElementById('sync-auto-toggle').checked = cfg.autoSync || false;
        }
        SyncManager.updateConnectionStatusUI();
        SyncManager.updateLastSyncUI();
        const connected = SyncManager.isConnected;
        document.getElementById('sync-upload-btn').disabled = !connected;
        document.getElementById('sync-download-btn').disabled = !connected;
        document.getElementById('sync-modal').classList.add('active');
      });
      document.getElementById('close-sync-modal').addEventListener('click', () => document.getElementById('sync-modal').classList.remove('active'));
      document.getElementById('sync-test-btn').addEventListener('click', async () => {
        const configStr = document.getElementById('sync-config-input').value.trim();
        const syncId = document.getElementById('sync-id-input').value.trim();
        if (!configStr || !syncId) { alert('FirebaseË®≠ÂÆö„Å®ÂêåÊúüID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
        try {
          SyncManager.initFirebase(configStr);
          SyncManager.syncId = syncId;
          await SyncManager.testConnection();
          SyncManager.updateConnectionStatusUI();
          document.getElementById('sync-upload-btn').disabled = false;
          document.getElementById('sync-download-btn').disabled = false;
          // Êé•Á∂öÊàêÂäüÊôÇ„Å´Ëá™Âãï‰øùÂ≠ò
          const autoSync = document.getElementById('sync-auto-toggle').checked;
          SyncManager.autoSync = autoSync;
          SyncManager.saveConfig(configStr, syncId, autoSync);
          alert('Êé•Á∂öÊàêÂäüÔºÅË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
        } catch(e) { SyncManager.isConnected = false; SyncManager.updateStatusDot('error'); SyncManager.updateConnectionStatusUI(); alert('Êé•Á∂öÂ§±Êïó: ' + e.message); }
      });
      document.getElementById('sync-save-config-btn').addEventListener('click', () => {
        const configStr = document.getElementById('sync-config-input').value.trim();
        const syncId = document.getElementById('sync-id-input').value.trim();
        const autoSync = document.getElementById('sync-auto-toggle').checked;
        if (!configStr || !syncId) { alert('FirebaseË®≠ÂÆö„Å®ÂêåÊúüID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
        SyncManager.syncId = syncId;
        SyncManager.autoSync = autoSync;
        SyncManager.saveConfig(configStr, syncId, autoSync);
        alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
      });
      document.getElementById('sync-upload-btn').addEventListener('click', () => SyncManager.upload(false));
      document.getElementById('sync-download-btn').addEventListener('click', () => {
        if (confirm('„ÇØ„É©„Ç¶„Éâ„ÅÆ„Éá„Éº„Çø„Åß„É≠„Éº„Ç´„É´„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÄÇ\n„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) { SyncManager.download(); }
      });
      document.getElementById('sync-auto-toggle').addEventListener('change', (e) => { SyncManager.autoSync = e.target.checked; });
      document.querySelectorAll('.chat-menu-item').forEach(item => {
        item.addEventListener('click', () => {
          const chatType = item.dataset.chatType;
          elements.chatMenuModal.classList.remove('active');
          handleClaireChat(chatType);
        });
      });
      // Â≠¶ÁøíÈñãÂßã„É¢„Éº„ÉÄ„É´
      document.getElementById('close-study-modal').addEventListener('click', () => closeStudyModal());
      document.getElementById('cancel-study').addEventListener('click', () => closeStudyModal());
      elements.studyTerritory.addEventListener('change', () => {
        elements.studyNext.style.display = elements.studyTerritory.value ? '' : 'none';
      });
      elements.studyNext.addEventListener('click', () => {
        const territoryId = elements.studyTerritory.value;
        elements.studyModal.classList.remove('active');
        showLibraryConfirmation(territoryId);
      });
      document.querySelectorAll('.mode-option').forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode;
          elements.studyModal.classList.remove('active');
          startStudyTimer(window._pendingStudyTerritoryId, mode);
        });
      });
      // „Çø„Ç§„Éû„ÉºÊìç‰Ωú
      elements.timerPause.addEventListener('click', toggleTimerPause);
      elements.timerStop.addEventListener('click', stopTimer);
    }

    function handleClaireChat(chatType) {
      const conversations = CLAIRE_CONVERSATIONS[chatType];
      if (!conversations || conversations.length === 0) return;
      const selected = conversations[Math.floor(Math.random() * conversations.length)];
      if (selected.pages) {
        showConversationPages(selected.pages, 0);
      } else {
        showDialogue(selected.text, selected.expression, [{ label: 'Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }]);
      }
    }

    function showConversationPages(pages, index) {
      const page = pages[index];
      const isLast = index >= pages.length - 1;
      if (isLast) {
        showDialogue(page.text, page.expression, [{ label: 'Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }]);
      } else {
        showDialogue(page.text, page.expression, [{ label: '‚ñ∂ Ê¨°„Å∏', value: '__NEXT_PAGE__' }]);
        // Ê¨°„Éö„Éº„Ç∏„Éè„É≥„Éâ„É©„Éº„Çí‰∏ÄÊôÇ‰øùÂ≠ò
        window._pendingPages = pages;
        window._pendingPageIndex = index + 1;
      }
    }

    function closeModalAndRestore(modalId) {
      document.getElementById(modalId).classList.remove('active');
      if (modalId === 'test-modal') { restoreBackground(); }
      const defaultDialogue = getDefaultDialogue();
      showDialogue(defaultDialogue.text, defaultDialogue.expression, defaultDialogue.actions);
    }

    function getTodayStudyMinutes() {
      const today = getTodayDateStr();
      return AppState.quests
        .filter(q => {
          const qDate = new Date(q.completedAt).toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' });
          return qDate === today;
        })
        .reduce((sum, q) => sum + (q.duration || 0), 0);
    }

    function getDefaultDialogue() {
      if (!AppState.kingdom) {
        return expandTemplate(CLAIRE_SYSTEM.defaultNoKingdom);
      }
      // Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì„Å´„Çà„ÇãÂàÜÂ≤ê
      const todayMin = getTodayStudyMinutes();
      const todayHours = Math.floor(todayMin / 60);
      if (todayHours >= 1) {
        const level = Math.min(todayHours, 6);
        const lines = CLAIRE_SYSTEM.studyProgress[level];
        if (lines && lines.length > 0) {
          const seed = new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' }) + '-' + level;
          let hash = 0;
          for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
          const picked = lines[Math.abs(hash) % lines.length];
          const actions = [
            { label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' },
            { label: 'Êõ∏Á∞°„ÇíÁ¢∫Ë™ç', value: 'Êõ∏Á∞°„ÇíÁ¢∫Ë™ç„Åó„Åü„ÅÑ' },
            { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: '„ÉÜ„Çπ„Éà„ÅÆÁµêÊûú„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' },
            { label: '‰ΩìË™ø„ÇíÂ†±Âëä', value: '‰ΩìË™ø„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' },
            { label: 'Èúß„ÅÆÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç', value: 'Âæ©Áøí„ÅåÂøÖË¶Å„Å™È†òÂúü„ÇíÊïô„Åà„Å¶' }
          ];
          return { text: 'üìö Êú¨Êó•„ÅÆÂ≠¶ÁøíÔºö' + todayMin + 'ÂàÜ\n\n' + picked.text, expression: picked.expression, actions: actions };
        }
      }
      return expandTemplate(CLAIRE_SYSTEM.default);
    }

    function setupTabNavigation() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        });
      });
    }

    async function handleSendMessage() {
      const content = elements.userInput.value.trim();
      if (!content) return;
      elements.userInput.value = '';
      elements.userInput.style.height = 'auto';
      // „Çø„Ç§„Éû„ÉºÂêåÂàÜÈáéÁ∂öË°å„ÅØÂç≥ÊôÇÂá¶ÁêÜ
      if (content === 'TIMER_SAME') { handleTimerSame(); return; }
      // ‰ºöË©±„Éö„Éº„Ç∏ÈÄÅ„Çä
      if (content === '__NEXT_PAGE__' && window._pendingPages) {
        showConversationPages(window._pendingPages, window._pendingPageIndex);
        return;
      }
      // ÂÜÖÈÉ®„Ç≥„Éû„É≥„ÉâÂá¶ÁêÜ
      if (handleInternalCommand(content)) { return; }
      elements.sendBtn.disabled = true;
      elements.dialogueText.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
      elements.quickActions.innerHTML = '';
      setExpression('normal');
      setTimeout(() => { const response = processUserMessage(content); if (response) { showDialogue(response.text, response.expression, response.actions); } elements.sendBtn.disabled = false; updateUI(); }, 800 + Math.random() * 400);
    }

    function processUserMessage(content) {
      const lower = content.toLowerCase();
      if (!AppState.kingdom && (lower.includes('aws') || lower.includes('Ë≥áÊ†º') || lower.includes('ÁéãÂõΩ'))) {
        if (lower.includes('aws') || lower.includes('saa')) { return createAWSKingdom(); }
        return { text: '„Å©„ÅÆ„Çà„ÅÜ„Å™Áü•Ë≠ò„ÅÆÈ†òÂüü„ÇíÁéãÂõΩ„Å®„Åó„Å¶ÂÆö„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÅãÔºü', expression: 'normal', actions: [{ label: 'AWS-SAA', value: 'AWS Solutions Architect Associate„ÅßÁéãÂõΩ„Çí‰ΩúÊàê' }] };
      }
      // Êõ∏Á∞°„ÇíÁ¢∫Ë™çÔºà‰∏ÄË¶ßË°®Á§∫Ôºâ- „ÄåÁ∂¥„Çã„Äç„ÄåË®ò„Åô„Äç„Çà„ÇäÂÖà„Å´Âà§ÂÆö
      if ((lower.includes('Êõ∏Á∞°') && (lower.includes('Á¢∫Ë™ç') || lower.includes('Ë¶ã') || lower.includes('‰∏ÄË¶ß') || lower.includes('Â±•Ê≠¥'))) || lower === 'Êõ∏Á∞°') { showQuestListInDialogue(0); return null; }
      if (lower.includes('Êõ∏Á∞°') && (lower.includes('Á∂¥') || lower.includes('Ë®ò'))) { startWriteQuestFlow(); return null; }
      if (lower.includes('Â≠¶Áøí') && (lower.includes('Ë®òÈå≤') || lower.includes('„Å§„Åë'))) { startWriteQuestFlow(); return null; }
      if (lower.includes('Êõ∏Á∞°') && lower.includes('Á∂¥„Çä„Åü„ÅÑ')) { startWriteQuestFlow(); return null; }
      if (lower.includes('ÈÅ†ÂæÅ') && (lower.includes('Âßã„ÇÅ') || lower.includes('„Åô„Çã') || lower.includes('ÈñãÂßã'))) { startWriteQuestFlow(); return null; }
      if (lower.includes('Â≠¶Áøí') && (lower.includes('Âßã„ÇÅ') || lower.includes('„Åô„Çã') || lower.includes('ÈñãÂßã'))) { startWriteQuestFlow(); return null; }
      if (content === '„É°„Ç§„É≥„Å´Êàª„Çã') { return getDefaultDialogue(); }
      // ‰ΩìË™øÈñ¢ÈÄ£
      if (lower.includes('‰ΩìË™ø') && (lower.includes('Â†±Âëä') || lower.includes('Ë®òÈå≤') || lower.includes('ÂÖ•Âäõ'))) { openConditionModal(); return null; }
      if (lower.includes('‰ΩìË™ø') && (lower.includes('ÂàÜÊûê') || lower.includes('ÊåØ„ÇäËøî') || lower.includes('ÂÇæÂêë'))) { showConditionAnalysis(); return null; }
      if (lower.includes('‰ΩìË™ø') && (lower.includes('Á¢∫Ë™ç') || lower.includes('Â±•Ê≠¥') || lower.includes('Ë¶ã'))) { showConditionLogInDialogue(0); return null; }
      if (lower.includes('ÁØùÁÅ´') && lower.includes('ÁÑö„Åπ')) { elements.testModal.classList.add('active'); setAltarBackground(); return { text: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã„ÅÆ„Åß„Åô„Å≠„ÄÇ\nÊµÑÂåñÂ∫¶70%‰ª•‰∏ä„ÅßÈúß„ÅåÊô¥„Çå„Åæ„Åô„ÄÇ', expression: 'serious', actions: [] }; }
      if (lower.includes('„ÉÜ„Çπ„Éà') && (lower.includes('ÁµêÊûú') || lower.includes('Â†±Âëä'))) { elements.testModal.classList.add('active'); setAltarBackground(); return { text: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã„ÅÆ„Åß„Åô„Å≠„ÄÇ\nÊµÑÂåñÂ∫¶70%‰ª•‰∏ä„ÅßÈúß„ÅåÊô¥„Çå„Åæ„Åô„ÄÇ', expression: 'serious', actions: [] }; }
      if (lower.includes('Âæ©Áøí') || lower.includes('‰∏çÁ©è') || lower.includes('Èúß')) {
        const reviewNeeded = getTerritoriesNeedingReview();
        if (reviewNeeded.length === 0) { return { text: 'ÁèæÂú®„ÄÅ„Åô„Åπ„Å¶„ÅÆÈ†òÂúü„ÅÆÈúß„ÅØÈùô„Åæ„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ', expression: 'smile', actions: [{ label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Åü„ÅÑ' }, { label: 'È†òÂúü„ÇíÁ¢∫Ë™ç', value: 'È†òÂúü„ÅÆÁä∂Ê≥Å„ÇíÊïô„Åà„Å¶' }] }; }
        const list = reviewNeeded.slice(0, 5).map(t => '„Éª' + t.name + 'Ôºà' + t.daysSinceReview + 'Êó•ÂâçÔºâ').join('\n');
        return { text: '‰ª•‰∏ã„ÅÆÈ†òÂúü„Å´ÂøòÂç¥„ÅÆÈúß„ÅåËø´„Å£„Å¶„Åä„Çä„Åæ„Åô„ÄÇ\n' + list, expression: 'worried', actions: [].concat(reviewNeeded.slice(0, 2).map(t => ({ label: t.name + '„ÅÆÊõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' })), [{ label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Åü„ÅÑ' }]) };
      }
      if (lower.includes('È†òÂúü') && (lower.includes('Áä∂Ê≥Å') || lower.includes('Êïô„Åà„Å¶') || lower.includes('Á¢∫Ë™ç'))) {
        if (!AppState.kingdom) { return { text: '„Åæ„Å†ÁéãÂõΩ„Åå‰ΩúÊàê„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ', expression: 'normal', actions: [{ label: 'AWS-SAA„Åß‰ΩúÊàê', value: 'AWS Solutions Architect Associate„ÅßÁéãÂõΩ„Çí‰ΩúÊàê' }] }; }
        return { text: AppState.kingdom.name + '„ÅÆÁèæÁä∂„Çí„ÅîÂ†±Âëä„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\nÊµÑÂåñÊ∏à„ÅøÈ†òÂúü: ' + AppState.territories.filter(t => t.conquered).length + ' / ' + AppState.territories.length + '\nÊµÑÂåñÁéá: ' + calculateProgress() + '%', expression: 'normal', actions: [{ label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Åü„ÅÑ' }, { label: 'Èúß„ÅÆÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç', value: 'Âæ©Áøí„ÅåÂøÖË¶Å„Å™È†òÂúü„ÇíÊïô„Åà„Å¶' }] };
      }
      if (AppState.kingdom) { return { text: '„ÅîÂëΩ‰ª§„Çí„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åô„ÄÇ', expression: 'normal', actions: [{ label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'Êõ∏Á∞°„ÇíÁ¢∫Ë™ç', value: 'Êõ∏Á∞°„ÇíÁ¢∫Ë™ç„Åó„Åü„ÅÑ' }, { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Åü„ÅÑ' }, { label: 'Èúß„ÅÆÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç', value: 'Âæ©Áøí„ÅåÂøÖË¶Å„Å™È†òÂúü„ÇíÊïô„Åà„Å¶' }] }; }
      return { text: 'ÁéãÂõΩ„Çí‰ΩúÊàê„ÅÑ„Åü„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ', expression: 'normal', actions: [{ label: 'AWS-SAA', value: 'AWS Solutions Architect Associate„ÅßÁéãÂõΩ„Çí‰ΩúÊàê' }] };
    }

    function createAWSKingdom() {
      AppState.kingdom = { name: 'AWS-SAAÁéãÂõΩ', createdAt: new Date().toISOString() };
      AppState.regions = [
        { id: 'core', name: '‰∏ªË¶Å„Å™„Çµ„Éº„Éì„ÇπÔºàÁéãÈÉΩ‰∏≠Â§ÆÔºâ' }, { id: 'compute', name: '„Ç≥„É≥„Éî„É•„Éº„ÉÜ„Ç£„É≥„Ç∞' }, { id: 'storage', name: '„Çπ„Éà„É¨„Éº„Ç∏' },
        { id: 'database', name: '„Éá„Éº„Çø„Éô„Éº„Çπ' }, { id: 'management', name: '„Éû„Éç„Ç∏„É°„É≥„Éà' }, { id: 'security', name: '„Çª„Ç≠„É•„É™„ÉÜ„Ç£' },
        { id: 'network', name: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ' }, { id: 'migration', name: 'ÁßªË°å„Å®Ëª¢ÈÄÅ' }, { id: 'integration', name: '„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áµ±Âêà' },
        { id: 'analytics', name: 'ÂàÜÊûê' }, { id: 'ml', name: 'Ê©üÊ¢∞Â≠¶Áøí' }, { id: 'other', name: '„Åù„ÅÆ‰ªñ' }, { id: 'wellarch', name: 'Well-Architected' }
      ];
      AppState.territories = [
        { id: 'ec2', name: 'EC2', regionId: 'core', conquered: false, prosperity: 0, lastReview: null },
        { id: 's3', name: 'S3', regionId: 'core', conquered: false, prosperity: 0, lastReview: null },
        { id: 'vpc', name: 'VPC', regionId: 'core', conquered: false, prosperity: 0, lastReview: null },
        { id: 'iam', name: 'IAM/Organizations', regionId: 'core', conquered: false, prosperity: 0, lastReview: null },
        { id: 'elb', name: 'ELB/Auto Scaling', regionId: 'core', conquered: false, prosperity: 0, lastReview: null },
        { id: 'lambda', name: 'Lambda/API Gateway', regionId: 'compute', conquered: false, prosperity: 0, lastReview: null },
        { id: 'ecs', name: 'ECS/Fargate/EKS', regionId: 'compute', conquered: false, prosperity: 0, lastReview: null },
        { id: 'ebs', name: 'EBS', regionId: 'storage', conquered: false, prosperity: 0, lastReview: null },
        { id: 'efs', name: 'EFS', regionId: 'storage', conquered: false, prosperity: 0, lastReview: null },
        { id: 'fsx', name: 'FSx', regionId: 'storage', conquered: false, prosperity: 0, lastReview: null },
        { id: 'rds', name: 'RDS/Aurora', regionId: 'database', conquered: false, prosperity: 0, lastReview: null },
        { id: 'dynamodb', name: 'DynamoDB', regionId: 'database', conquered: false, prosperity: 0, lastReview: null },
        { id: 'elasticache', name: 'ElastiCache', regionId: 'database', conquered: false, prosperity: 0, lastReview: null },
        { id: 'cloudwatch', name: 'CloudWatch', regionId: 'management', conquered: false, prosperity: 0, lastReview: null },
        { id: 'cloudtrail', name: 'CloudTrail', regionId: 'management', conquered: false, prosperity: 0, lastReview: null },
        { id: 'cloudformation', name: 'CloudFormation', regionId: 'management', conquered: false, prosperity: 0, lastReview: null },
        { id: 'waf', name: 'WAF/Shield', regionId: 'security', conquered: false, prosperity: 0, lastReview: null },
        { id: 'kms', name: 'KMS/CloudHSM', regionId: 'security', conquered: false, prosperity: 0, lastReview: null },
        { id: 'route53', name: 'Route 53', regionId: 'network', conquered: false, prosperity: 0, lastReview: null },
        { id: 'cloudfront', name: 'CloudFront', regionId: 'network', conquered: false, prosperity: 0, lastReview: null },
        { id: 'directconnect', name: 'Direct Connect/VPN', regionId: 'network', conquered: false, prosperity: 0, lastReview: null },
        { id: 'datasync', name: 'DataSync/Snowball', regionId: 'migration', conquered: false, prosperity: 0, lastReview: null },
        { id: 'sqs', name: 'SNS/SQS/MQ', regionId: 'integration', conquered: false, prosperity: 0, lastReview: null },
        { id: 'kinesis', name: 'Kinesis', regionId: 'analytics', conquered: false, prosperity: 0, lastReview: null },
        { id: 'glue', name: 'Glue/EMR', regionId: 'analytics', conquered: false, prosperity: 0, lastReview: null },
        { id: 'athena', name: 'Athena/QuickSight', regionId: 'analytics', conquered: false, prosperity: 0, lastReview: null },
        { id: 'sagemaker', name: 'SageMaker', regionId: 'ml', conquered: false, prosperity: 0, lastReview: null },
        { id: 'other', name: '„Åù„ÅÆ‰ªñ', regionId: 'other', conquered: false, prosperity: 0, lastReview: null },
        { id: 'reliability', name: '‰ø°È†ºÊÄß', regionId: 'wellarch', conquered: false, prosperity: 0, lastReview: null },
        { id: 'security-wa', name: '„Çª„Ç≠„É•„É™„ÉÜ„Ç£', regionId: 'wellarch', conquered: false, prosperity: 0, lastReview: null },
        { id: 'cost', name: '„Ç≥„Çπ„ÉàÊúÄÈÅ©Âåñ', regionId: 'wellarch', conquered: false, prosperity: 0, lastReview: null }
      ];
      saveState(); updateUI();
      setTimeout(checkAchievements, 500);
      return expandTemplate(CLAIRE_EVENTS.kingdomCreated, { kingdomName: AppState.kingdom.name, regionCount: AppState.regions.length, territoryCount: AppState.territories.length });
    }

    function calculateProgress() { if (AppState.territories.length === 0) return 0; return Math.round((AppState.territories.filter(t => t.conquered).length / AppState.territories.length) * 100); }

    function getTerritoriesNeedingReview() {
      const now = new Date();
      return AppState.territories.filter(t => t.conquered && t.lastReview).map(t => {
        const daysSince = Math.floor((now - new Date(t.lastReview)) / (1000 * 60 * 60 * 24));
        return { ...t, daysSinceReview: daysSince };
      }).filter(t => [1, 3, 7, 14, 30].some(i => t.daysSinceReview >= i && t.daysSinceReview < i + 3)).sort((a, b) => b.daysSinceReview - a.daysSinceReview);
    }

    function updateUI() { updateStats(); updateRegionsGrid(); updateTerritorySelects(); checkReviewAlerts(); updateStreakUI(); renderAchievements(); renderItems(); }

    function updateStats() {
      elements.totalQuests.textContent = AppState.quests.length;
      elements.conqueredTerritories.textContent = AppState.territories.filter(t => t.conquered).length;
      elements.totalTerritories.textContent = AppState.territories.length;
      if (AppState.kingdom) { elements.kingdomName.textContent = AppState.kingdom.name; elements.kingdomProgress.textContent = 'ÊµÑÂåñÁéá: ' + calculateProgress() + '%'; }
    }

    function updateRegionsGrid() {
      if (!AppState.kingdom || AppState.regions.length === 0) { elements.regionsContainer.innerHTML = '<div class="map-placeholder"><div class="map-placeholder-icon">üó∫Ô∏è</div><p>„Åæ„Å†ÁéãÂõΩ„Åå‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p></div>'; return; }
      elements.regionsContainer.innerHTML = AppState.regions.map(region => {
        const territories = AppState.territories.filter(t => t.regionId === region.id);
        const conqueredCount = territories.filter(t => t.conquered).length;
        const avgProsperity = territories.length > 0 ? Math.round(territories.reduce((sum, t) => sum + t.prosperity, 0) / territories.length) : 0;
        return '<div class="region-card ' + (conqueredCount === territories.length ? 'conquered' : '') + '"><div class="region-header"><span class="region-name">' + region.name + '</span><span class="region-status ' + (conqueredCount === territories.length ? 'conquered' : '') + '">' + conqueredCount + '/' + territories.length + '</span></div><div class="region-territories">' + territories.map(t => '<span class="territory-tag ' + (t.conquered ? 'conquered' : '') + '" data-territory-id="' + t.id + '">' + t.name + '</span>').join('') + '</div>' + (conqueredCount > 0 ? '<div class="region-prosperity"><div class="prosperity-bar"><div class="prosperity-fill" style="width: ' + avgProsperity + '%"></div></div><span class="prosperity-value">' + avgProsperity + '%</span></div>' : '') + '</div>';
      }).join('');
      // È†òÂúü„Çø„Ç∞„Å´„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
      document.querySelectorAll('.territory-tag').forEach(tag => {
        tag.addEventListener('click', () => openTerritoryDetail(tag.dataset.territoryId));
      });
    }

    function openTerritoryDetail(territoryId) {
      const territory = AppState.territories.find(t => t.id === territoryId);
      if (!territory) return;
      AppState.currentTerritoryId = territoryId;
      elements.territoryModalTitle.textContent = territory.name;

      // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
      const lastReviewDate = territory.lastReview ? new Date(territory.lastReview).toLocaleDateString('ja-JP') : 'Êú™Â≠¶Áøí';
      elements.territoryDetailStatus.innerHTML = 
        '<div class="territory-status-row"><span class="territory-status-label">Áä∂ÊÖã</span><span class="territory-status-value ' + (territory.conquered ? 'conquered' : 'unconquered') + '">' + (territory.conquered ? 'ÊµÑÂåñÊ∏à„Åø ‚úì' : 'Êú™ÊµÑÂåñ') + '</span></div>' +
        '<div class="territory-status-row"><span class="territory-status-label">ÊµÑÂåñÂ∫¶</span><span class="territory-status-value">' + territory.prosperity + '%</span></div>' +
        '<div class="territory-status-row"><span class="territory-status-label">ÊúÄÁµÇÂ≠¶Áøí</span><span class="territory-status-value">' + lastReviewDate + '</span></div>';

      // Áµ±Ë®àÊÉÖÂ†±
      const relatedQuests = AppState.quests.filter(q => q.territoryId === territoryId);
      const relatedTests = AppState.testHistory.filter(h => h.territoryId === territoryId);
      const totalMinutes = relatedQuests.reduce((sum, q) => sum + (q.duration || 0), 0);
      const avgScore = relatedTests.length > 0 ? Math.round(relatedTests.reduce((sum, h) => sum + h.score, 0) / relatedTests.length) : 0;
      const timeStr = totalMinutes >= 60 ? Math.floor(totalMinutes / 60) + 'ÊôÇÈñì' + (totalMinutes % 60 > 0 ? totalMinutes % 60 + 'ÂàÜ' : '') : totalMinutes + 'ÂàÜ';
      elements.territoryDetailStats.innerHTML =
        '<div class="td-stat"><div class="td-stat-value">' + relatedQuests.length + '</div><div class="td-stat-label">Êõ∏Á∞°Êï∞</div></div>' +
        '<div class="td-stat"><div class="td-stat-value">' + timeStr + '</div><div class="td-stat-label">Á¥ØË®àÂ≠¶ÁøíÊôÇÈñì</div></div>' +
        '<div class="td-stat"><div class="td-stat-value">' + (relatedTests.length > 0 ? avgScore + '%' : '‚Äî') + '</div><div class="td-stat-label">Âπ≥ÂùáÊµÑÂåñÂ∫¶</div></div>';

      // Êõ∏Á∞°„ÅÆË®òÈå≤
      const questsSorted = relatedQuests.slice().sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
      const questsToShow = questsSorted.slice(0, 5);
      if (questsSorted.length === 0) {
        elements.territoryQuestList.innerHTML = '<div class="territory-history-empty">„Åæ„Å†Êõ∏Á∞°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      } else {
        let questHtml = questsToShow.map(q => {
          const dateStr = new Date(q.completedAt).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
          const durStr = q.duration ? q.duration + 'ÂàÜ' : '';
          const hasMemo = q.memo ? 'üìù' : '';
          return '<div class="territory-quest-item" data-quest-id="' + q.id + '">' +
            '<div class="tqi-icon">üìú</div>' +
            '<div class="tqi-body">' +
              '<div class="tqi-title">' + q.title + ' ' + hasMemo + '</div>' +
              '<div class="tqi-meta">' + dateStr + (durStr ? '„ÄÄ' + durStr : '') + '</div>' +
            '</div>' +
            '<div class="tqi-arrow">‚ñ∂</div>' +
          '</div>';
        }).join('');
        if (questsSorted.length > 5) {
          questHtml += '<div class="territory-detail-more" id="td-quest-more">„Åï„Çâ„Å´' + (questsSorted.length - 5) + '‰ª∂„ÇíË°®Á§∫</div>';
        }
        elements.territoryQuestList.innerHTML = questHtml;
      }

      // Êõ∏Á∞°„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
      elements.territoryQuestList.querySelectorAll('.territory-quest-item[data-quest-id]').forEach(item => {
        item.addEventListener('click', () => {
          elements.territoryModal.classList.remove('active');
          showQuestDetailInDialogue(item.dataset.questId);
        });
      });
      // „ÇÇ„Å£„Å®Ë°®Á§∫
      const moreBtn = document.getElementById('td-quest-more');
      if (moreBtn) {
        moreBtn.addEventListener('click', () => {
          const allHtml = questsSorted.map(q => {
            const dateStr = new Date(q.completedAt).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            const durStr = q.duration ? q.duration + 'ÂàÜ' : '';
            const hasMemo = q.memo ? 'üìù' : '';
            return '<div class="territory-quest-item" data-quest-id="' + q.id + '">' +
              '<div class="tqi-icon">üìú</div>' +
              '<div class="tqi-body">' +
                '<div class="tqi-title">' + q.title + ' ' + hasMemo + '</div>' +
                '<div class="tqi-meta">' + dateStr + (durStr ? '„ÄÄ' + durStr : '') + '</div>' +
              '</div>' +
              '<div class="tqi-arrow">‚ñ∂</div>' +
            '</div>';
          }).join('');
          elements.territoryQuestList.innerHTML = allHtml;
          elements.territoryQuestList.querySelectorAll('.territory-quest-item[data-quest-id]').forEach(item => {
            item.addEventListener('click', () => {
              elements.territoryModal.classList.remove('active');
              showQuestDetailInDialogue(item.dataset.questId);
            });
          });
        });
      }

      // „ÉÜ„Çπ„ÉàÂ±•Ê≠¥Ë°®Á§∫Ôºà„É°„É¢‰ªò„ÅçÔºâ
      const history = relatedTests.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
      if (history.length === 0) {
        elements.territoryHistoryList.innerHTML = '<div class="territory-history-empty">„Åæ„Å†ÁØùÁÅ´„Å´ÁÑö„Åπ„ÅüË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
      } else {
        elements.territoryHistoryList.innerHTML = history.map(h => {
          const scoreClass = h.score >= 80 ? 'high' : h.score >= 70 ? 'medium' : 'low';
          const dateStr = new Date(h.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
          const noteHtml = h.note ? '<span class="tti-note">' + h.note.replace(/</g, '&lt;') + '</span>' : '';
          return '<div class="territory-test-item">' +
            '<span class="tti-date">' + dateStr + '</span>' +
            '<span class="tti-score ' + scoreClass + '">' + h.score + '%</span>' +
            noteHtml +
          '</div>';
        }).join('');
      }

      // „É°„É¢Ë°®Á§∫
      elements.territoryMemo.value = AppState.territoryMemos[territoryId] || '';

      // „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
      elements.territoryDetailActions.innerHTML =
        '<button class="btn-action" id="td-action-quest">üìú Êõ∏Á∞°„ÇíÁ∂¥„Çã</button>' +
        '<button class="btn-action" id="td-action-test">üî• ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã</button>';
      document.getElementById('td-action-quest').addEventListener('click', () => {
        elements.territoryModal.classList.remove('active');
        startWriteQuestFlow();
      });
      document.getElementById('td-action-test').addEventListener('click', () => {
        elements.territoryModal.classList.remove('active');
        document.getElementById('test-territory').value = territoryId;
        elements.testModal.classList.add('active');
        setAltarBackground();
      });

      elements.territoryModal.classList.add('active');
    }

    function saveTerritoryMemo() {
      if (!AppState.currentTerritoryId) return;
      AppState.territoryMemos[AppState.currentTerritoryId] = elements.territoryMemo.value;
      saveState();
      elements.territoryModal.classList.remove('active');
    }

    function updateTerritorySelects() {
      const options = AppState.territories.map(t => '<option value="' + t.id + '">' + t.name + '</option>').join('');
      document.getElementById('quest-territory').innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' + options;
      document.getElementById('test-territory').innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' + options;
      document.getElementById('study-territory').innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>' + options;
    }

    function checkReviewAlerts() {
      const needsReview = getTerritoriesNeedingReview();
      elements.reviewNotification.style.display = needsReview.length > 0 ? 'block' : 'none';
      if (needsReview.length === 0) { elements.reviewList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ú®</div><p>„Åô„Åπ„Å¶„ÅÆÈ†òÂúü„ÅåÂÆâÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô</p></div>'; }
      else { elements.reviewList.innerHTML = needsReview.map(t => '<div class="alert-card"><div class="alert-icon">‚ö†Ô∏è</div><div class="alert-content"><div class="alert-title">' + t.name + '</div><div class="alert-message">' + t.daysSinceReview + 'Êó•Ââç - ÊµÑÂåñÂ∫¶: ' + t.prosperity + '%</div></div><button class="alert-action" onclick="openTestModalFor(\'' + t.id + '\')">Âæ©Áøí</button></div>').join(''); }
    }

    window.openTestModalFor = function(id) { document.getElementById('test-territory').value = id; elements.testModal.classList.add('active'); setAltarBackground(); };

    function saveQuest() {
      const title = document.getElementById('quest-title').value.trim();
      const territoryId = document.getElementById('quest-territory').value;
      const duration = parseInt(document.getElementById('quest-duration').value) || 30;
      const memo = document.getElementById('quest-memo').value.trim();
      if (!title) { alert('Êõ∏Á∞°„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      AppState.quests.push({ id: Date.now().toString(), title, territoryId, duration, memo, completedAt: new Date().toISOString() });
      saveState();
      document.getElementById('quest-title').value = ''; document.getElementById('quest-territory').value = ''; document.getElementById('quest-duration').value = ''; document.getElementById('quest-memo').value = '';
      elements.questModal.classList.remove('active'); updateUI();
      const milestone = recordStudyDay();
      if (milestone) {
        showMilestonePopup(milestone);
      } else {
        const questDialogue = expandTemplate(CLAIRE_EVENTS.questSaved, { title: title, duration: duration });
        showDialogue(questDialogue.text, questDialogue.expression, questDialogue.actions || [{ label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: '„ÉÜ„Çπ„Éà„ÅÆÁµêÊûú„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' }]);
      }
      setTimeout(checkAchievements, 500);
    }

    function saveTestResult() {
      const territoryId = document.getElementById('test-territory').value;
      const score = parseInt(document.getElementById('test-score').value);
      const note = document.getElementById('test-note').value.trim();
      if (!territoryId || isNaN(score) || score < 0 || score > 100) { alert('È†òÂúü„Å®ÊµÑÂåñÂ∫¶„ÇíÊ≠£„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      const territory = AppState.territories.find(t => t.id === territoryId);
      if (!territory) return;
      territory.lastReview = new Date().toISOString();
      territory.prosperity = score;
      if (score >= 70) territory.conquered = true;
      AppState.testHistory.push({ id: Date.now().toString(), territoryId, score, note, date: new Date().toISOString() });
      saveState();
      document.getElementById('test-territory').value = ''; document.getElementById('test-score').value = ''; document.getElementById('test-note').value = '';
      elements.testModal.classList.remove('active'); updateUI();

      // ÁµêÊûú„Çª„É™„Éï„ÇíÊ∫ñÂÇô
      let response;
      if (score >= 90) { response = expandTemplate(CLAIRE_EVENTS.testExcellent, { territoryName: territory.name, score: score }); }
      else if (score >= 70) { response = expandTemplate(CLAIRE_EVENTS.testPassed, { territoryName: territory.name, score: score }); }
      else { response = expandTemplate(CLAIRE_EVENTS.testFailed, { territoryName: territory.name, score: score }); }
      const actions = score >= 70 ? [{ label: 'Ê¨°„ÅÆÈ†òÂúü„ÅÆÊõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'Á∂ö„Åë„Å¶ÁÑö„Åπ„Çã', value: '„ÉÜ„Çπ„Éà„ÅÆÁµêÊûú„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' }, { label: 'Âü∑ÂãôÂÆ§„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }] : [{ label: 'ÂÜç„Å≥Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'ÂÜç„Å≥ÁÑö„Åπ„Çã', value: territory.name + '„ÅÆ„ÉÜ„Çπ„ÉàÁµêÊûú„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' }, { label: 'Âü∑ÂãôÂÆ§„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }];
      const milestone = recordStudyDay();

      // ÁØùÁÅ´ÊºîÂá∫‚ÜíÁµêÊûúË°®Á§∫
      playBonfireOffering(() => {
        restoreBackground();
        if (milestone) {
          showDialogue(response.text, response.expression, actions);
          setTimeout(() => showMilestonePopup(milestone), 800);
        } else {
          showDialogue(response.text, response.expression, actions);
        }
        setTimeout(checkAchievements, 500);
      });
    }

    function playBonfireOffering(callback) {
      const overlay = document.getElementById('bonfire-overlay');
      const video = document.getElementById('bonfire-video');
      const skipBtn = document.getElementById('bonfire-skip');

      // „ÇØ„É¨„Ç¢„Çπ„Éó„É©„Ç§„Éà„Å®„Çª„É™„Éï„ÇíÈö†„Åô
      elements.claireSprite.style.opacity = '0';
      elements.dialogueText.innerHTML = '';
      elements.quickActions.innerHTML = '';

      overlay.classList.add('active');
      video.currentTime = 0;
      video.play().catch(() => {
        // Ëá™ÂãïÂÜçÁîü„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        finishBonfireOffering(callback);
      });

      function finishBonfireOffering(cb) {
        video.pause();
        // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
        overlay.style.transition = 'opacity 0.8s ease';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.classList.remove('active');
          overlay.style.transition = '';
          overlay.style.opacity = '';
          elements.claireSprite.style.opacity = '';
          cb();
        }, 800);
      }

      // ÂãïÁîªÁµÇ‰∫ÜÊôÇ
      const onEnded = () => {
        video.removeEventListener('ended', onEnded);
        skipBtn.removeEventListener('click', onSkip);
        finishBonfireOffering(callback);
      };
      // „Çπ„Ç≠„ÉÉ„Éó
      const onSkip = () => {
        video.removeEventListener('ended', onEnded);
        skipBtn.removeEventListener('click', onSkip);
        finishBonfireOffering(callback);
      };

      video.addEventListener('ended', onEnded);
      skipBtn.addEventListener('click', onSkip);
    }
    function saveState() {
      AppState.lastModified = new Date().toISOString();
      localStorage.setItem('rekingdom-state', JSON.stringify(AppState));
      if (SyncManager.isConnected && SyncManager.autoSync) { SyncManager.upload(true); }
    }
    function loadState() { const saved = localStorage.getItem('rekingdom-state'); if (saved) { Object.assign(AppState, JSON.parse(saved)); } if (!AppState.streak) { AppState.streak = { current: 0, longest: 0, lastStudyDate: null, titles: [] }; } if (!AppState.achievements) { AppState.achievements = {}; } if (!AppState.items) { AppState.items = {}; } if (!AppState.conditionLogs) { AppState.conditionLogs = []; } if (!AppState.territoryMemos) { AppState.territoryMemos = {}; } }

    // === „ÇØ„É©„Ç¶„ÉâÂêåÊúüÔºàFirebase FirestoreÔºâ ===

    const SYNC_CONFIG_KEY = 'rekingdom-sync-config';

    const SyncManager = {
      db: null,
      isConnected: false,
      autoSync: false,
      syncId: '',
      lastSyncAt: null,
      _uploadTimer: null,

      loadConfig() {
        const raw = localStorage.getItem(SYNC_CONFIG_KEY);
        if (!raw) return null;
        try { return JSON.parse(raw); } catch(e) { return null; }
      },

      saveConfig(firebaseConfigStr, syncId, autoSync) {
        const config = { firebaseConfig: firebaseConfigStr, syncId: syncId, autoSync: autoSync, lastSyncAt: this.lastSyncAt };
        localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(config));
      },

      initFirebase(configStr) {
        if (typeof firebase === 'undefined') { throw new Error('Firebase SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\n„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); }
        let config;
        try {
          // „Åæ„ÅöÊ®ôÊ∫ñJSON„Å®„Åó„Å¶„Éë„Éº„ÇπË©¶Ë°å
          config = JSON.parse(configStr);
        } catch(e) {
          try {
            // JSÂΩ¢ÂºèÔºà„Ç≠„Éº„Å´„ÇØ„Ç©„Éº„Éà„Å™„ÅóÔºâ„ÇíÊ≠£Ë¶èJSON„Å´Â§âÊèõ„Åó„Å¶„É™„Éà„É©„Ç§
            const fixed = configStr.replace(/;\s*$/, '').replace(/([{,]\s*)(\w+)\s*:/g, '$1"$2":');
            config = JSON.parse(fixed);
          } catch(e2) {
            throw new Error('FirebaseË®≠ÂÆö„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nConfig„ÅÆ { } ÈÉ®ÂàÜ„Çí„Åù„ÅÆ„Åæ„ÅæË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
        }
        if (!config.apiKey || !config.projectId) { throw new Error('apiKey„Å®projectId„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ'); }
        // Êó¢Â≠òapp„Åå„ÅÇ„Çå„Å∞‰Ωø„ÅÑÂõû„Åô
        if (firebase.apps.length === 0) { firebase.initializeApp(config); }
        this.db = firebase.firestore();
        this.isConnected = true;
        this.updateStatusDot('connected');
      },

      async testConnection() {
        if (!this.db || !this.syncId) throw new Error('Ë®≠ÂÆö„Åå‰∏çÂÆåÂÖ®„Åß„Åô„ÄÇ');
        // Firestore„Å´Ë™≠„ÅøÂèñ„Çä„ÉÜ„Çπ„Éà
        await this.db.collection('rekingdom').doc(this.syncId).get();
        return true;
      },

      async upload(silent) {
        if (!this.db || !this.syncId) return;
        try {
          this.updateStatusDot('syncing');
          const data = { state: JSON.stringify(AppState), updatedAt: firebase.firestore.FieldValue.serverTimestamp(), lastModified: AppState.lastModified || new Date().toISOString() };
          await this.db.collection('rekingdom').doc(this.syncId).set(data);
          this.lastSyncAt = new Date().toISOString();
          this.updateLastSyncUI();
          this.updateStatusDot('connected');
          // Ë®≠ÂÆö„Å´lastSyncAt„Çí‰øùÂ≠ò
          const cfg = this.loadConfig();
          if (cfg) { cfg.lastSyncAt = this.lastSyncAt; localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(cfg)); }
          if (!silent) { this.showSyncToast('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü'); }
        } catch(e) {
          this.updateStatusDot('error');
          if (!silent) { alert('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó: ' + e.message); }
        }
      },

      async download() {
        if (!this.db || !this.syncId) return;
        try {
          this.updateStatusDot('syncing');
          const doc = await this.db.collection('rekingdom').doc(this.syncId).get();
          if (!doc.exists) { alert('„ÇØ„É©„Ç¶„Éâ„Å´„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\nÂÖà„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); this.updateStatusDot('connected'); return; }
          const cloudState = JSON.parse(doc.data().state);
          // AppState„Çí„ÇØ„É©„Ç¶„Éâ„Éá„Éº„Çø„Åß‰∏äÊõ∏„Åç
          Object.keys(AppState).forEach(k => delete AppState[k]);
          Object.assign(AppState, cloudState);
          saveStateLocal(); // „É≠„Éº„Ç´„É´„ÅÆ„Åø‰øùÂ≠òÔºàÂÜçÂ∏∞Èò≤Ê≠¢Ôºâ
          updateUI();
          renderAchievements();
          renderItems();
          this.lastSyncAt = new Date().toISOString();
          this.updateLastSyncUI();
          this.updateStatusDot('connected');
          const cfg = this.loadConfig();
          if (cfg) { cfg.lastSyncAt = this.lastSyncAt; localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(cfg)); }
          this.showSyncToast('„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫Ü');
        } catch(e) {
          this.updateStatusDot('error');
          alert('„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂ§±Êïó: ' + e.message);
        }
      },

      async checkCloudOnLoad() {
        if (!this.db || !this.syncId) return;
        try {
          const doc = await this.db.collection('rekingdom').doc(this.syncId).get();
          if (!doc.exists) return;
          const cloudLastMod = doc.data().lastModified;
          const localLastMod = AppState.lastModified;
          if (cloudLastMod && localLastMod && cloudLastMod > localLastMod) {
            this.showCloudNewerNotice();
          }
        } catch(e) { /* silent fail */ }
      },

      showCloudNewerNotice() {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--bg-medium);border:1px solid var(--accent-gold);border-radius:10px;padding:0.75rem 1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem;align-items:center;font-size:0.8rem;color:var(--text-primary);box-shadow:0 4px 20px rgba(0,0,0,0.5);max-width:280px;';
        toast.innerHTML = '<div>‚òÅÔ∏è „ÇØ„É©„Ç¶„Éâ„Å´Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åô</div><div style="display:flex;gap:0.5rem;"><button id="cloud-sync-yes" style="padding:0.35rem 1rem;border-radius:6px;border:1px solid var(--accent-gold);background:rgba(201,162,39,0.15);color:var(--accent-gold);cursor:pointer;font-size:0.8rem;">ÂêåÊúü„Åô„Çã</button><button id="cloud-sync-no" style="padding:0.35rem 1rem;border-radius:6px;border:1px solid var(--border-color);background:none;color:var(--text-secondary);cursor:pointer;font-size:0.8rem;">Âæå„Åß</button></div>';
        document.body.appendChild(toast);
        document.getElementById('cloud-sync-yes').addEventListener('click', () => { toast.remove(); this.download(); });
        document.getElementById('cloud-sync-no').addEventListener('click', () => { toast.remove(); });
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 15000);
      },

      showSyncToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--bg-medium);border:1px solid var(--accent-gold);border-radius:8px;padding:0.5rem 1.2rem;z-index:10000;font-size:0.8rem;color:var(--accent-gold);box-shadow:0 4px 15px rgba(0,0,0,0.4);transition:opacity 0.5s;';
        toast.textContent = '‚òÅÔ∏è ' + message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2000);
      },

      updateStatusDot(state) {
        const dot = document.getElementById('sync-status-dot');
        if (!dot) return;
        dot.className = 'sync-status-dot ' + state;
      },

      updateLastSyncUI() {
        const el = document.getElementById('sync-last-sync');
        if (el && this.lastSyncAt) { el.textContent = 'ÊúÄÁµÇÂêåÊúü: ' + new Date(this.lastSyncAt).toLocaleString('ja-JP'); }
      },

      updateConnectionStatusUI() {
        const el = document.getElementById('sync-connection-status');
        if (el) { el.textContent = this.isConnected ? '‚úÖ Êé•Á∂öÊ∏à„Åø' : '‚ùå Êú™Êé•Á∂ö'; }
      },

      // Ëµ∑ÂãïÊôÇ„Å´‰øùÂ≠òÊ∏à„ÅøË®≠ÂÆö„ÅßËá™ÂãïÊé•Á∂ö
      autoConnect() {
        const cfg = this.loadConfig();
        if (!cfg || !cfg.firebaseConfig || !cfg.syncId) return;
        try {
          this.initFirebase(cfg.firebaseConfig);
          this.syncId = cfg.syncId;
          this.autoSync = cfg.autoSync || false;
          this.lastSyncAt = cfg.lastSyncAt || null;
          this.checkCloudOnLoad();
        } catch(e) { /* silent fail */ }
      }
    };

    // saveState„ÅÆ„É≠„Éº„Ç´„É´Â∞ÇÁî®ÁâàÔºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊôÇ„ÅÆÂÜçÂ∏∞Èò≤Ê≠¢Áî®Ôºâ
    function saveStateLocal() { AppState.lastModified = new Date().toISOString(); localStorage.setItem('rekingdom-state', JSON.stringify(AppState)); }

    // === „Çø„Ç§„Éû„ÉºÊ©üËÉΩ ===

    // === Êõ∏Á∞°„ÇíÁ∂¥„Çã„Éï„É≠„Éº ===

    function startWriteQuestFlow() {
      showDialogue('Êõ∏Á∞°„ÇíÁ∂¥„Çã„ÅÆ„Åß„Åô„Å≠ÔºÅ\n„ÅäÂæÖ„Å°„Åó„Å¶„Åä„Çä„Åæ„Åó„Åü„ÄÇ', 'smile', [
        { label: '„ÅØ„ÅÑ', value: '__WRITE_QUEST_STEP2__' }
      ]);
    }

    // ÂÜÖÈÉ®„Ç≥„Éû„É≥„Éâ„ÇíhandleSendMessageÂâç„Å´Âá¶ÁêÜ
    function handleInternalCommand(content) {
      if (content === '__WRITE_QUEST_STEP2__') {
        showDialogue('„Åß„ÅØ„ÄÅÁõÆÁöÑ„Å®„Åô„ÇãÂú∞Âüü„ÅØ„Å©„Åì„Å´„ÅÑ„Åü„Åó„Åæ„Åó„Çá„ÅÜ„Åã„ÄÇ', 'normal', [
          { label: 'Âú∞Âüü„ÇíÈÅ∏„Å∂', value: '__WRITE_QUEST_STEP3__' }
        ]);
        return true;
      }
      if (content === '__WRITE_QUEST_STEP3__') {
        openStudyModal();
        return true;
      }
      if (content === '__LIBRARY_CONFIRM_YES__') {
        showDialogue('„Åß„ÅØ„ÄÅÂÖ±„Å´ÂèÇ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ', 'smile', [
          { label: '‚ñ∂', value: '__LIBRARY_TRANSITION__' }
        ]);
        return true;
      }
      if (content === '__LIBRARY_TRANSITION__') {
        playLibraryTransition(() => {
          if (!AppState.visitedLibrary) {
            AppState.visitedLibrary = true;
            saveState();
            showDialogue('‚Ä¶‚Ä¶‰πÖ„Åó„Å∂„Çä„Å´„ÄÅ„Åì„ÅÆÂõ≥Êõ∏ÂÆ§„Å´‰∫∫„ÅÆÊ∞óÈÖç„ÅåÊàª„Çä„Åæ„Åó„Åü„ÄÇ\nÊú∫„ÅÆ‰∏ä„ÅÆÂüÉ„ÅåÂ∞ë„ÅóÁî≥„ÅóË®≥„Å™„Åï„Åù„ÅÜ„Åß„Åô„Å≠„ÄÇ', 'thinking', [
              { label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: '__LIBRARY_OPEN_MODE__' }
            ]);
          } else {
            showDialogue('Âõ≥Êõ∏ÂÆ§„Å´Âà∞ÁùÄ„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\nÁÅØÁ≠Ü„ÅÆÊ∫ñÂÇô„ÅØ‰∏áÂÖ®„Åß„Åô„ÄÇ‚Ä¶‚Ä¶„Åï„ÅÇ„ÄÅÁ∂¥„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ', 'smile', [
              { label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: '__LIBRARY_OPEN_MODE__' }
            ]);
          }
        });
        return true;
      }
      if (content === '__LIBRARY_OPEN_MODE__') {
        openModeSelectModal();
        return true;
      }
      if (content === '__LIBRARY_CONFIRM_NO__') {
        restoreBackground();
        showDialogue('„Åã„Åó„Åì„Åæ„Çä„Åæ„Åó„Åü„ÄÇ\nÊ∫ñÂÇô„Åå„Åß„Åç„Åü„Çâ„ÄÅ„Åæ„Åü„ÅäÂ£∞Êéõ„Åë„Åè„Å†„Åï„ÅÑ„ÄÇ', 'smile', [
          { label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' },
          { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Åü„ÅÑ' },
          { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
        ]);
        return true;
      }
      if (content === '__QUEST_LIST_BACK__') {
        showQuestListInDialogue(window._questListPage || 0);
        return true;
      }
      return false;
    }

    function showLibraryConfirmation(territoryId) {
      window._pendingStudyTerritoryId = territoryId;
      showDialogue('„Åß„ÅØ„ÄÅÂõ≥Êõ∏ÂÆ§„Å∏ÁßªÂãï„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ\nÊ∫ñÂÇô„ÅØ„Çà„Çç„Åó„ÅÑ„Åß„Åó„Çá„ÅÜ„ÅãÔºü', 'normal', [
        { label: '„Çè„Åã„Å£„Åü', value: '__LIBRARY_CONFIRM_YES__' },
        { label: 'Â∞ë„ÅóÂæÖ„Å£„Å¶„Åª„Åó„ÅÑ', value: '__LIBRARY_CONFIRM_NO__' }
      ]);
    }

    function openModeSelectModal() {
      elements.studyStepTerritory.classList.remove('active');
      elements.studyStepMode.classList.add('active');
      elements.studyModalTitle.textContent = 'Êõ∏Á∞°„ÅÆÁ∂¥„ÇäÊñπ„ÇíÈÅ∏Êäû';
      elements.studyNext.style.display = 'none';
      elements.studyModal.classList.add('active');
      const territory = AppState.territories.find(t => t.id === window._pendingStudyTerritoryId);
      if (territory) {
        const d = expandTemplate(CLAIRE_EVENTS.studySelectMode, { territoryName: territory.name });
        showDialogue(d.text, d.expression, []);
      }
    }

    function openStudyModal() {
      elements.studyStepTerritory.classList.add('active');
      elements.studyStepMode.classList.remove('active');
      elements.studyModalTitle.textContent = 'Êõ∏Á∞°„ÅÆÂØæË±°„ÇíÈÅ∏Êäû';
      elements.studyTerritory.value = '';
      elements.studyNext.style.display = 'none';
      elements.studyModal.classList.add('active');
      const d = expandTemplate(CLAIRE_EVENTS.studySelectTerritory);
      showDialogue(d.text, d.expression, []);
    }

    function closeStudyModal() {
      elements.studyModal.classList.remove('active');
      const d = getDefaultDialogue();
      showDialogue(d.text, d.expression, d.actions);
    }

    function startStudyTimer(territoryId, mode) {
      const territory = AppState.territories.find(t => t.id === territoryId);
      if (!territory) return;

      TimerState.active = true;
      TimerState.paused = false;
      TimerState.mode = mode;
      TimerState.phase = mode === 'pomodoro' ? 'work' : null;
      TimerState.territoryId = territoryId;
      TimerState.territoryName = territory.name;
      TimerState.elapsed = 0;
      TimerState.totalStudyMinutes = 0;
      TimerState.remaining = mode === 'pomodoro' ? 25 * 60 : 0;

      elements.timerTerritory.textContent = '‚öîÔ∏è ' + territory.name;
      updateTimerDisplay();
      elements.timerOverlay.classList.add('active');
      elements.timerPause.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';

      const dialogue = expandTemplate(CLAIRE_EVENTS.timerStart, { territoryName: territory.name });
      showDialogue(dialogue.text, dialogue.expression, []);

      TimerState.intervalId = setInterval(tickTimer, 1000);
    }

    function tickTimer() {
      if (TimerState.paused) return;

      if (TimerState.mode === 'pomodoro') {
        TimerState.remaining--;
        if (TimerState.phase === 'work') {
          TimerState.elapsed++;
        }
        if (TimerState.remaining <= 0) {
          if (TimerState.phase === 'work') {
            completePomodorWork();
          } else {
            completePomodoroBreak();
          }
          return;
        }
      } else {
        TimerState.elapsed++;
      }
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      if (TimerState.mode === 'pomodoro') {
        elements.timerTime.textContent = formatTime(TimerState.remaining);
        if (TimerState.phase === 'work') {
          elements.timerPhase.textContent = 'üî• ÈõÜ‰∏≠„Çø„Ç§„É†';
          elements.timerPhase.className = 'timer-phase work';
          elements.timerTime.className = 'timer-time';
        } else {
          elements.timerPhase.textContent = '‚òï ‰ºëÊÜ©„Çø„Ç§„É†';
          elements.timerPhase.className = 'timer-phase break';
          elements.timerTime.className = 'timer-time break';
        }
      } else {
        elements.timerTime.textContent = formatTime(TimerState.elapsed);
        elements.timerPhase.textContent = '‚úíÔ∏è ÁÅØÁ≠ÜÂü∑Á≠Ü‰∏≠';
        elements.timerPhase.className = 'timer-phase work';
        elements.timerTime.className = 'timer-time';
      }
    }

    function toggleTimerPause() {
      TimerState.paused = !TimerState.paused;
      elements.timerPause.textContent = TimerState.paused ? 'ÂÜçÈñã' : '‰∏ÄÊôÇÂÅúÊ≠¢';
      if (TimerState.paused) {
        const lines = CLAIRE_TIMER_PAUSED;
        const line = lines[Math.floor(Math.random() * lines.length)];
        showDialogue(line.text, line.expression, []);
      } else {
        const lines = CLAIRE_TIMER_RESUMED;
        const line = lines[Math.floor(Math.random() * lines.length)];
        showDialogue(line.text, line.expression, []);
      }
    }

    function stopTimer() {
      clearInterval(TimerState.intervalId);
      TimerState.active = false;
      elements.timerOverlay.classList.remove('active');
      restoreBackground();

      // ‰ΩúÊ•≠‰∏≠„ÅÆÂ†¥Âêà„ÅÆ„ÅøÁµåÈÅéÊôÇÈñì„ÇíÂä†ÁÆóÔºà‰ºëÊÜ©‰∏≠„ÅØÂä†ÁÆó„Åó„Å™„ÅÑÔºâ
      if (TimerState.mode === 'free' || (TimerState.mode === 'pomodoro' && TimerState.phase === 'work')) {
        const studyMinutes = Math.max(1, Math.round(TimerState.elapsed / 60));
        TimerState.totalStudyMinutes += studyMinutes;
      }

      if (TimerState.totalStudyMinutes >= 1) {
        autoRegisterQuest(TimerState.territoryId, TimerState.territoryName, TimerState.totalStudyMinutes);
      }

      const dialogue = expandTemplate(CLAIRE_EVENTS.freeStudyDone, { territoryName: TimerState.territoryName, duration: TimerState.totalStudyMinutes || 1 });
      showDialogue(dialogue.text, dialogue.expression, [
        { label: 'Á∂ö„Åë„Å¶Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' },
        { label: 'ÁØùÁÅ´„Å´ÁÑö„Åπ„Çã', value: '„ÉÜ„Çπ„Éà„ÅÆÁµêÊûú„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' }
      ]);
    }

    function completePomodorWork() {
      clearInterval(TimerState.intervalId);
      playNotificationSound();

      const studyMinutes = Math.round(TimerState.elapsed / 60);
      TimerState.totalStudyMinutes += studyMinutes;

      TimerState.phase = 'break';
      TimerState.remaining = 5 * 60;
      TimerState.elapsed = 0;
      updateTimerDisplay();

      const dialogue = expandTemplate(CLAIRE_EVENTS.pomodoroWorkDone);
      showDialogue(dialogue.text, dialogue.expression, []);

      TimerState.intervalId = setInterval(tickTimer, 1000);
    }

    function completePomodoroBreak() {
      clearInterval(TimerState.intervalId);
      TimerState.active = false;
      elements.timerOverlay.classList.remove('active');
      restoreBackground();
      playNotificationSound();

      autoRegisterQuest(TimerState.territoryId, TimerState.territoryName, TimerState.totalStudyMinutes);

      const dialogue = expandTemplate(CLAIRE_EVENTS.pomodoroBreakDone, { territoryName: TimerState.territoryName, duration: TimerState.totalStudyMinutes });
      showDialogue(dialogue.text, dialogue.expression, [
        { label: 'Âêå„ÅòÂàÜÈáé„ÅßÁ∂ö„Åë„Çã', value: 'TIMER_SAME' },
        { label: 'Âà•„ÅÆÈ†òÂúü„ÅßÊõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' },
        { label: 'ÁÅØÁ≠Ü„ÇíÁΩÆ„Åè', value: '„ÅîËã¶Âä¥„Å†„Å£„Åü' }
      ]);
    }

    function autoRegisterQuest(territoryId, territoryName, minutes) {
      AppState.quests.push({
        id: Date.now().toString(),
        title: territoryName + ' „ÅÆÊõ∏Á∞°',
        territoryId: territoryId,
        duration: minutes,
        memo: '',
        completedAt: new Date().toISOString()
      });
      saveState();
      updateUI();
      const milestone = recordStudyDay();
      if (milestone) {
        setTimeout(() => showMilestonePopup(milestone), 500);
      }
      setTimeout(checkAchievements, 600);
    }

    function playNotificationSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, start, dur) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.3, ctx.currentTime + start);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + start + dur);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(ctx.currentTime + start);
          osc.stop(ctx.currentTime + start + dur);
        };
        playTone(523, 0, 0.2);
        playTone(659, 0.2, 0.2);
        playTone(784, 0.4, 0.4);
      } catch (e) { /* Audio not supported */ }
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // „ÄåÂêå„ÅòÂàÜÈáé„ÅßÁ∂ö„Åë„Çã„Äç„Éè„É≥„Éâ„É©„Éº
    function handleTimerSame() {
      TimerState.totalStudyMinutes = 0;
      setLibraryBackground();
      startStudyTimer(TimerState.territoryId, 'pomodoro');
    }

    // === ‰ΩìË™øË®òÈå≤„Ç∑„Çπ„ÉÜ„É† ===

    const SYMPTOM_TAGS = {
      headache: 'ü§ï È†≠Áóõ', sleepy: 'üò™ Áú†Ê∞ó', stiff: 'üí™ ËÇ©„Åì„Çä', eyestrain: 'üëÅÔ∏è ÁõÆ„ÅÆÁñ≤„Çå',
      fatigue: 'ü•± „Å†„Çã„Åï', stomach: 'ü§¢ ËÉÉËÖ∏„ÅÆ‰∏çË™ø', stress: 'üò∞ „Çπ„Éà„É¨„Çπ', unfocused: 'üåÄ ÈõÜ‰∏≠Âäõ‰Ωé‰∏ã'
    };
    const CONDITION_LEVELS = ['', 'üòµ ÊúÄÊÇ™', 'üòî ÊÇ™„ÅÑ', 'üòê ÊôÆÈÄö', 'üòä ËâØ„ÅÑ', 'üòÑ Áµ∂Â•ΩË™ø'];

    function getTodayDateStr() {
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      return jst.getFullYear() + '-' + String(jst.getMonth() + 1).padStart(2, '0') + '-' + String(jst.getDate()).padStart(2, '0');
    }

    function getTodayCondition() {
      const today = getTodayDateStr();
      return AppState.conditionLogs.find(c => c.date === today);
    }

    function openConditionModal() {
      const existing = getTodayCondition();
      // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
      document.querySelectorAll('.cond-level-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.cond-tag').forEach(b => b.classList.remove('active'));
      document.getElementById('cond-sleep').value = '';
      document.getElementById('cond-caffeine').value = '';
      document.getElementById('cond-meal-b').checked = false;
      document.getElementById('cond-meal-l').checked = false;
      document.getElementById('cond-meal-d').checked = false;
      document.getElementById('cond-temp').value = '';
      document.getElementById('cond-pressure').value = '';
      document.getElementById('cond-note').value = '';
      // Êó¢Â≠ò„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
      if (existing) {
        const lvlBtn = document.querySelector('.cond-level-btn[data-level="' + existing.condition + '"]');
        if (lvlBtn) lvlBtn.classList.add('active');
        (existing.symptoms || []).forEach(s => {
          const tag = document.querySelector('.cond-tag[data-tag="' + s + '"]');
          if (tag) tag.classList.add('active');
        });
        if (existing.sleepHours != null) document.getElementById('cond-sleep').value = existing.sleepHours;
        if (existing.caffeine != null) document.getElementById('cond-caffeine').value = existing.caffeine;
        if (existing.meals) {
          document.getElementById('cond-meal-b').checked = !!existing.meals.breakfast;
          document.getElementById('cond-meal-l').checked = !!existing.meals.lunch;
          document.getElementById('cond-meal-d').checked = !!existing.meals.dinner;
        }
        if (existing.temperature != null) document.getElementById('cond-temp').value = existing.temperature;
        if (existing.pressure != null) document.getElementById('cond-pressure').value = existing.pressure;
        if (existing.note) document.getElementById('cond-note').value = existing.note;
      }
      document.getElementById('condition-modal').classList.add('active');
      showDialogue('„Åî‰ΩìË™ø„ÅÆÂ†±Âëä„Åß„Åô„Å≠„ÄÇ\nÊ≠£Áõ¥„Å´„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ', 'thinking', []);
    }

    function saveCondition() {
      const activeLevel = document.querySelector('.cond-level-btn.active');
      if (!activeLevel) { alert('‰ΩìË™ø„É¨„Éô„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      const condition = parseInt(activeLevel.dataset.level);
      const symptoms = Array.from(document.querySelectorAll('.cond-tag.active')).map(b => b.dataset.tag);
      const sleepVal = document.getElementById('cond-sleep').value;
      const caffeineVal = document.getElementById('cond-caffeine').value;
      const tempVal = document.getElementById('cond-temp').value;
      const pressureVal = document.getElementById('cond-pressure').value;
      const note = document.getElementById('cond-note').value.trim();
      const meals = {
        breakfast: document.getElementById('cond-meal-b').checked,
        lunch: document.getElementById('cond-meal-l').checked,
        dinner: document.getElementById('cond-meal-d').checked
      };

      const today = getTodayDateStr();
      const entry = {
        id: Date.now().toString(),
        date: today,
        condition: condition,
        symptoms: symptoms,
        sleepHours: sleepVal !== '' ? parseFloat(sleepVal) : null,
        caffeine: caffeineVal !== '' ? parseInt(caffeineVal) : null,
        meals: meals,
        temperature: tempVal !== '' ? parseFloat(tempVal) : null,
        pressure: pressureVal !== '' ? parseFloat(pressureVal) : null,
        note: note,
        createdAt: new Date().toISOString()
      };

      // ‰ªäÊó•„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞‰∏äÊõ∏„Åç
      const existingIdx = AppState.conditionLogs.findIndex(c => c.date === today);
      if (existingIdx >= 0) {
        AppState.conditionLogs[existingIdx] = entry;
      } else {
        AppState.conditionLogs.push(entry);
      }
      saveState();

      document.getElementById('condition-modal').classList.remove('active');
      const comment = getConditionComment(entry);
      showDialogue(comment.text, comment.expression, [
        { label: '‰ΩìË™ø„ÅÆÂàÜÊûê„ÇíË¶ã„Çã', value: '‰ΩìË™ø„ÇíÂàÜÊûê„Åó„Åü„ÅÑ' },
        { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
      ]);
    }

    function getConditionComment(entry) {
      const lv = entry.condition;
      const syms = entry.symptoms || [];
      if (lv <= 1) {
        return { text: '‚Ä¶‚Ä¶„ÅäËæõ„Åù„ÅÜ„Åß„Åô„Å≠„ÄÇ\nÁÑ°ÁêÜ„ÅØÁ¶ÅÁâ©„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ‰ªäÊó•„ÅØÁÅØÁ≠Ü„ÇíÁΩÆ„ÅÑ„Å¶„ÄÅ„Åä‰Ωì„Çí‰ºë„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nÁØùÁÅ´„ÅØ„Åì„ÅÆ„ÇØ„É¨„Ç¢„ÅåÂÆà„Çä„Åæ„Åô„Åã„Çâ„ÄÇ', expression: 'worried' };
      }
      if (lv === 2) {
        if (syms.includes('headache')) return { text: 'È†≠Áóõ„Åå„Åä„ÅÇ„Çä„Å™„ÅÆ„Åß„Åô„Å≠‚Ä¶‚Ä¶„ÄÇ\nÊ∏©„Åã„ÅÑ„ÅäÈ£≤„ÅøÁâ©„Åß„ÇÇ„ÅÑ„Åã„Åå„Åß„Åó„Çá„ÅÜ„ÄÇ\nÁü≠„ÅÑÊõ∏Á∞°„Å†„Åë„Åß„ÇÇ„ÄÅ„Åç„Å£„Å®Âäõ„Å´„Å™„Çä„Åæ„Åô„ÄÇ', expression: 'worried' };
        return { text: 'Â∞ë„Åó„ÅäÁñ≤„Çå„ÅÆ„Çà„ÅÜ„Åß„Åô„Å≠„ÄÇ\n„Åè„Çå„Åê„Çå„ÇÇ„ÅîÁÑ°ÁêÜ„Å™„Åï„Çâ„Åö„ÄÅ„Åß„Åç„ÇãÁØÑÂõ≤„Åß„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ', expression: 'thinking' };
      }
      if (lv === 3) {
        return { text: 'ÊâøÁü•„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\n‰ΩìË™ø„ÅÆË®òÈå≤„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n‰ªäÊó•„ÇÇ„Åß„Åç„ÇãÁØÑÂõ≤„Åß„ÄÅÂÖ±„Å´ÂèÇ„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ', expression: 'normal' };
      }
      if (lv === 4) {
        return { text: 'ËâØ„ÅÑ‰ΩìË™ø„Å®„ÅÆ„Åì„Å®„ÄÅ‰Ωï„Çà„Çä„Åß„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ\n„Åì„ÅÆË™øÂ≠ê„ÅßÊõ∏Á∞°„ÇíÁ∂¥„Çå„Å∞„ÄÅ„Åç„Å£„Å®Êçó„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ', expression: 'smile' };
      }
      return { text: 'Áµ∂Â•ΩË™ø„Å®„ÅÆ„Åì„Å®ÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ\n‰ªäÊó•„ÅØÁÅØÁ≠Ü„ÅåÂÜ¥„ÅàÊ∏°„Çã„Åì„Å®ÈñìÈÅï„ÅÑ„Å™„Åó„Åß„Åô„ÄÇ\nÂ≠òÂàÜ„Å´Èúß„ÇíÊô¥„Çâ„Åó„Å¶„Åæ„ÅÑ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ', expression: 'proud' };
    }

    function showConditionLogInDialogue(page) {
      page = page || 0;
      window._conditionLogPage = page;
      setExpression('normal');
      elements.quickActions.innerHTML = '';

      const logs = AppState.conditionLogs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const pageSize = 5;
      const totalPages = Math.max(1, Math.ceil(logs.length / pageSize));
      if (page >= totalPages) page = totalPages - 1;
      if (page < 0) page = 0;

      let html;
      if (logs.length === 0) {
        html = '<p>‰ΩìË™ø„ÅÆË®òÈå≤„ÅØ„Åæ„Å†„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p><div class="dialogue-quest-empty">üìã „Äå‰ΩìË™ø„ÇíÂ†±Âëä„Äç„ÅßË®òÈå≤„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</div>';
      } else {
        html = '<p>‰ΩìË™ø„ÅÆË®òÈå≤„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÔºàÂÖ®' + logs.length + '‰ª∂Ôºâ</p>';
        const pageLogs = logs.slice(page * pageSize, (page + 1) * pageSize);
        html += '<div class="dialogue-quest-list">' + pageLogs.map(c => {
          const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
          const d = new Date(c.date + 'T00:00:00+09:00');
          const dayStr = c.date.slice(5) + 'Ôºà' + dayNames[d.getDay()] + 'Ôºâ';
          const symStr = (c.symptoms || []).slice(0, 3).map(s => SYMPTOM_TAGS[s] || s).join(' ');
          return '<div class="dialogue-quest-card">' +
            '<div class="dqc-icon" style="font-size:1.3rem;">' + CONDITION_LEVELS[c.condition].split(' ')[0] + '</div>' +
            '<div class="dqc-body">' +
              '<div class="dqc-title">' + CONDITION_LEVELS[c.condition].split(' ')[1] + (c.sleepHours != null ? '„ÄÄüí§' + c.sleepHours + 'h' : '') + '</div>' +
              '<div class="dqc-meta">' + dayStr + (symStr ? '„ÄÄ' + symStr : '') + '</div>' +
            '</div>' +
          '</div>';
        }).join('') + '</div>';
        if (totalPages > 1) {
          html += '<div class="dialogue-quest-nav">' +
            '<button id="cond-page-prev" ' + (page <= 0 ? 'disabled' : '') + '>‚óÄ Ââç</button>' +
            '<span>' + (page + 1) + ' / ' + totalPages + '</span>' +
            '<button id="cond-page-next" ' + (page >= totalPages - 1 ? 'disabled' : '') + '>Ê¨° ‚ñ∂</button>' +
          '</div>';
        }
      }
      elements.dialogueText.innerHTML = html;

      const prevBtn = document.getElementById('cond-page-prev');
      const nextBtn = document.getElementById('cond-page-next');
      if (prevBtn) prevBtn.addEventListener('click', () => showConditionLogInDialogue(page - 1));
      if (nextBtn) nextBtn.addEventListener('click', () => showConditionLogInDialogue(page + 1));

      const actions = [
        { label: '‰ΩìË™ø„ÇíÂ†±Âëä', value: '‰ΩìË™ø„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' },
        { label: '‰ΩìË™ø„ÅÆÂàÜÊûê', value: '‰ΩìË™ø„ÇíÂàÜÊûê„Åó„Åü„ÅÑ' },
        { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
      ];
      elements.quickActions.innerHTML = actions.map(a => '<button class="quick-action-btn" data-value="' + a.value + '">' + a.label + '</button>').join('');
      elements.quickActions.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => { if (btn.dataset.value) { elements.userInput.value = btn.dataset.value; handleSendMessage(); } });
      });
    }

    function showConditionAnalysis() {
      setExpression('thinking');
      elements.quickActions.innerHTML = '';

      const logs = AppState.conditionLogs;
      if (logs.length < 3) {
        showDialogue('ÂàÜÊûê„Å´„ÅØÊúÄ‰Ωé3Êó•ÂàÜ„ÅÆË®òÈå≤„ÅåÂøÖË¶Å„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n„ÇÇ„ÅÜÂ∞ë„Åó‰ΩìË™ø„ÅÆÂ†±Âëä„ÇíÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ„Åæ„Åõ„ÄÇ', 'thinking', [
          { label: '‰ΩìË™ø„ÇíÂ†±Âëä', value: '‰ΩìË™ø„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' },
          { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
        ]);
        return;
      }

      let html = '<div class="cond-analysis">';

      // 1. ÊõúÊó•Âà•Âπ≥Âùá‰ΩìË™ø
      const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
      const dayData = Array(7).fill(null).map(() => ({ total: 0, count: 0 }));
      logs.forEach(c => {
        const d = new Date(c.date + 'T00:00:00+09:00');
        const day = d.getDay();
        dayData[day].total += c.condition;
        dayData[day].count++;
      });
      const dayOrder = [1, 2, 3, 4, 5, 6, 0]; // Êúà„ÄúÊó•
      const maxAvg = 5;
      html += '<div class="cond-chart-section"><div class="cond-chart-title">üìä ÊõúÊó•Âà•„ÅÆÂπ≥Âùá‰ΩìË™ø</div>';
      html += '<div class="cond-bar-chart">' + dayOrder.map(i => {
        const avg = dayData[i].count > 0 ? (dayData[i].total / dayData[i].count) : 0;
        const barH = Math.max(Math.round((avg / maxAvg) * 60), 2);
        const color = avg >= 4 ? '#6abf7b' : avg >= 3 ? 'var(--accent-gold)' : avg >= 2 ? '#e89040' : '#e86464';
        return '<div class="cond-bar-col">' +
          '<div class="cond-bar-value">' + (avg > 0 ? avg.toFixed(1) : '‚Äî') + '</div>' +
          '<div class="cond-bar" style="height:' + barH + 'px;background:' + (avg > 0 ? color : 'var(--border-subtle)') + ';"></div>' +
          '<div class="cond-bar-label">' + dayNames[i] + '</div>' +
        '</div>';
      }).join('') + '</div></div>';

      // 2. ‰ΩìË™ø√óÂ≠¶ÁøíÊôÇÈñì„ÅÆÁõ∏Èñ¢
      html += '<div class="cond-chart-section"><div class="cond-chart-title">üìà ‰ΩìË™ø„É¨„Éô„É´Âà•„ÅÆÂπ≥ÂùáÂ≠¶ÁøíÊôÇÈñì</div>';
      const levelStudy = Array(6).fill(null).map(() => ({ totalMin: 0, count: 0 }));
      logs.forEach(c => {
        const dayQuests = AppState.quests.filter(q => {
          const qDate = new Date(q.completedAt).toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' });
          return qDate === c.date;
        });
        const dayMin = dayQuests.reduce((s, q) => s + (q.duration || 0), 0);
        levelStudy[c.condition].totalMin += dayMin;
        levelStudy[c.condition].count++;
      });
      html += '<div class="cond-bar-chart">' + [1, 2, 3, 4, 5].map(lv => {
        const avg = levelStudy[lv].count > 0 ? Math.round(levelStudy[lv].totalMin / levelStudy[lv].count) : 0;
        const maxMin = Math.max(...[1, 2, 3, 4, 5].map(l => levelStudy[l].count > 0 ? levelStudy[l].totalMin / levelStudy[l].count : 0), 1);
        const barH = Math.max(Math.round((avg / maxMin) * 60), 2);
        return '<div class="cond-bar-col">' +
          '<div class="cond-bar-value">' + (avg > 0 ? avg + 'ÂàÜ' : '‚Äî') + '</div>' +
          '<div class="cond-bar" style="height:' + barH + 'px;background:var(--accent-gold);"></div>' +
          '<div class="cond-bar-label">' + CONDITION_LEVELS[lv].split(' ')[0] + '</div>' +
        '</div>';
      }).join('') + '</div></div>';

      // 3. ÁóáÁä∂„É©„É≥„Ç≠„É≥„Ç∞
      const symCount = {};
      logs.forEach(c => (c.symptoms || []).forEach(s => { symCount[s] = (symCount[s] || 0) + 1; }));
      const symRank = Object.entries(symCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
      if (symRank.length > 0) {
        const maxCount = symRank[0][1];
        html += '<div class="cond-chart-section"><div class="cond-chart-title">üè∑Ô∏è „Çà„Åè„ÅÇ„ÇãÁóáÁä∂</div>';
        html += symRank.map(([tag, count]) => {
          const pct = (count / maxCount) * 100;
          return '<div class="cond-tag-freq">' +
            '<span class="cond-tag-freq-name">' + (SYMPTOM_TAGS[tag] || tag) + '</span>' +
            '<div style="flex:1;background:var(--bg-medium);border-radius:3px;overflow:hidden;">' +
              '<div class="cond-tag-freq-bar" style="width:' + pct + '%;"></div>' +
            '</div>' +
            '<span class="cond-tag-freq-count">' + count + 'Âõû</span>' +
          '</div>';
        }).join('') + '</div>';
      }

      // 4. „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ
      const avgCond = (logs.reduce((s, c) => s + c.condition, 0) / logs.length).toFixed(1);
      const sleepLogs = logs.filter(c => c.sleepHours != null);
      const avgSleep = sleepLogs.length > 0 ? (sleepLogs.reduce((s, c) => s + c.sleepHours, 0) / sleepLogs.length).toFixed(1) : '‚Äî';
      const cafLogs = logs.filter(c => c.caffeine != null);
      const avgCaf = cafLogs.length > 0 ? (cafLogs.reduce((s, c) => s + c.caffeine, 0) / cafLogs.length).toFixed(1) : '‚Äî';
      html += '<div class="cond-chart-section"><div class="cond-chart-title">üìã „Çµ„Éû„É™„ÉºÔºà' + logs.length + 'Êó•ÂàÜÔºâ</div>';
      html += '<div class="cond-stat-grid">' +
        '<div class="cond-stat-card"><div class="cond-stat-card-title">Âπ≥Âùá‰ΩìË™ø</div><div class="cond-stat-card-value">' + avgCond + ' / 5</div></div>' +
        '<div class="cond-stat-card"><div class="cond-stat-card-title">Âπ≥ÂùáÁù°Áú†</div><div class="cond-stat-card-value">' + avgSleep + (avgSleep !== '‚Äî' ? 'h' : '') + '</div></div>' +
        '<div class="cond-stat-card"><div class="cond-stat-card-title">Âπ≥Âùá„Ç´„Éï„Çß„Ç§„É≥</div><div class="cond-stat-card-value">' + avgCaf + (avgCaf !== '‚Äî' ? 'ÊùØ' : '') + '</div></div>' +
        '<div class="cond-stat-card"><div class="cond-stat-card-title">Ë®òÈå≤Êó•Êï∞</div><div class="cond-stat-card-value">' + logs.length + 'Êó•</div></div>' +
      '</div></div>';

      // 5. „Ç§„É≥„Çµ„Ç§„ÉàÔºàËá™ÂãïÂàÜÊûê„Ç≥„É°„É≥„ÉàÔºâ
      const insights = [];
      // ÊõúÊó•ÂàÜÊûê
      let bestDay = -1, bestDayAvg = 0;
      dayOrder.forEach(i => {
        if (dayData[i].count >= 2) {
          const avg = dayData[i].total / dayData[i].count;
          if (avg > bestDayAvg) { bestDayAvg = avg; bestDay = i; }
        }
      });
      if (bestDay >= 0) insights.push(dayNames[bestDay] + 'ÊõúÊó•„ÅÆ‰ΩìË™ø„ÅåÊúÄ„ÇÇËâØ„ÅÑÂÇæÂêë„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÂπ≥Âùá' + bestDayAvg.toFixed(1) + 'Ôºâ„ÄÇ');
      // Áù°Áú†ÂàÜÊûê
      if (sleepLogs.length >= 3) {
        const goodSleep = sleepLogs.filter(c => c.condition >= 4);
        const badSleep = sleepLogs.filter(c => c.condition <= 2);
        if (goodSleep.length > 0 && badSleep.length > 0) {
          const goodAvg = (goodSleep.reduce((s, c) => s + c.sleepHours, 0) / goodSleep.length).toFixed(1);
          const badAvg = (badSleep.reduce((s, c) => s + c.sleepHours, 0) / badSleep.length).toFixed(1);
          if (parseFloat(goodAvg) > parseFloat(badAvg)) {
            insights.push('‰ΩìË™ø„ÅåËâØ„ÅÑÊó•„ÅÆÂπ≥ÂùáÁù°Áú†„ÅØ' + goodAvg + 'ÊôÇÈñì„ÄÅÊÇ™„ÅÑÊó•„ÅØ' + badAvg + 'ÊôÇÈñì„Åß„Åô„ÄÇ');
          }
        }
      }
      // Ê∞óÂúßÂàÜÊûê
      const pressLogs = logs.filter(c => c.pressure != null);
      if (pressLogs.length >= 3) {
        const lowPress = pressLogs.filter(c => c.pressure < 1010);
        const highPress = pressLogs.filter(c => c.pressure >= 1013);
        if (lowPress.length > 0 && highPress.length > 0) {
          const lowAvg = (lowPress.reduce((s, c) => s + c.condition, 0) / lowPress.length).toFixed(1);
          const highAvg = (highPress.reduce((s, c) => s + c.condition, 0) / highPress.length).toFixed(1);
          if (parseFloat(highAvg) - parseFloat(lowAvg) >= 0.5) {
            insights.push('‰ΩéÊ∞óÂúßÔºà<1010hPaÔºâ„ÅÆÊó•„ÅØ‰ΩìË™ø„Åå‰∏ã„Åå„ÇãÂÇæÂêë„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
          }
        }
      }

      if (insights.length > 0) {
        html += '<div class="cond-chart-section"><div class="cond-chart-title">üí° „ÇØ„É¨„Ç¢„ÅÆÊâÄË¶ã</div>';
        html += '<div class="cond-insight">' + insights.join('<br>') + '</div></div>';
      }

      html += '</div>';
      elements.dialogueText.innerHTML = html;

      const actions = [
        { label: '‰ΩìË™ø„ÅÆÂ±•Ê≠¥', value: '‰ΩìË™ø„ÅÆÂ±•Ê≠¥„ÇíË¶ã„Åü„ÅÑ' },
        { label: '‰ΩìË™ø„ÇíÂ†±Âëä', value: '‰ΩìË™ø„ÇíÂ†±Âëä„Åó„Åü„ÅÑ' },
        { label: '„É°„Ç§„É≥„Å´Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }
      ];
      elements.quickActions.innerHTML = actions.map(a => '<button class="quick-action-btn" data-value="' + a.value + '">' + a.label + '</button>').join('');
      elements.quickActions.querySelectorAll('.quick-action-btn').forEach(btn => {
        btn.addEventListener('click', () => { if (btn.dataset.value) { elements.userInput.value = btn.dataset.value; handleSendMessage(); } });
      });
    }

    // === ÂÆüÁ∏æ„Ç∑„Çπ„ÉÜ„É† ===

    const ACHIEVEMENTS = [
      // Â≠¶ÁøíË®òÈå≤Á≥ª
      { id: 'first_quest',    icon: 'üìú', name: 'ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©',       desc: 'Âàù„ÇÅ„Å¶Êõ∏Á∞°„ÇíÁ∂¥„Å£„Åü',         check: () => AppState.quests.length >= 1 },
      { id: 'quest_10',       icon: 'üìö', name: 'ÂçÅ„ÅÆËªåË∑°',        desc: 'Êõ∏Á∞°„Çí10ÈÄöÁ∂¥„Å£„Åü',           check: () => AppState.quests.length >= 10 },
      { id: 'quest_30',       icon: 'üìñ', name: '‰∏âÂçÅ„ÅÆËªåË∑°',      desc: 'Êõ∏Á∞°„Çí30ÈÄöÁ∂¥„Å£„Åü',           check: () => AppState.quests.length >= 30 },
      { id: 'quest_100',      icon: 'üèõÔ∏è', name: 'Áôæ„ÅÆÂè°Êô∫',        desc: 'Êõ∏Á∞°„Çí100ÈÄöÁ∂¥„Å£„Åü',          check: () => AppState.quests.length >= 100 },
      // ÊµÑÂåñÁ≥ª
      { id: 'first_conquer',  icon: 'üïØÔ∏è', name: 'ÊúÄÂàù„ÅÆÁÅØ„Çä',      desc: 'Âàù„ÇÅ„Å¶È†òÂúü„ÅÆÈúß„ÇíÊô¥„Çâ„Åó„Åü',     check: () => AppState.territories.filter(t => t.conquered).length >= 1 },
      { id: 'conquer_5',      icon: 'üõ°Ô∏è', name: '‰∫î„Å§„ÅÆÁÅØÁÅ´',      desc: '5„Å§„ÅÆÈ†òÂúü„ÅÆÈúß„ÇíÊô¥„Çâ„Åó„Åü',      check: () => AppState.territories.filter(t => t.conquered).length >= 5 },
      { id: 'conquer_10',     icon: 'üëë', name: 'ÂçÅ„ÅÆÁÅØÁÅ´',        desc: '10„ÅÆÈ†òÂúü„ÅÆÈúß„ÇíÊô¥„Çâ„Åó„Åü',       check: () => AppState.territories.filter(t => t.conquered).length >= 10 },
      { id: 'conquer_all',    icon: 'üåü', name: 'ÂÆåÂÖ®„Å™„ÇãÊµÑÂåñ',    desc: 'ÂÖ®„Å¶„ÅÆÈ†òÂúü„ÅÆÈúß„ÇíÊô¥„Çâ„Åó„Åü',     check: () => AppState.territories.length > 0 && AppState.territories.every(t => t.conquered) },
      // „ÉÜ„Çπ„ÉàÁ≥ª
      { id: 'perfect_score',  icon: 'üíé', name: 'ÂÆåÁíß„Å™„ÇãÁÇé',      desc: 'ÊµÑÂåñÂ∫¶100%„ÇíÈÅîÊàê„Åó„Åü',       check: () => AppState.testHistory.some(t => t.score === 100) },
      { id: 'test_10',        icon: 'üìù', name: 'ÂçÅ„ÅÆÁåÆÁÅ´',        desc: 'ÁØùÁÅ´„Å´10ÂõûÊõ∏Á∞°„ÇíÁÑö„Åπ„Åü',     check: () => AppState.testHistory.length >= 10 },
      // Â≠¶ÁøíÊôÇÈñìÁ≥ª
      { id: 'study_5h',       icon: '‚è∞', name: '‰∫îÊôÇÈñì„ÅÆÁ†îÈëΩ',    desc: 'Á¥ØË®à5ÊôÇÈñì„ÅÆÈÅ†ÂæÅ„ÇíÈÅîÊàê',        check: () => getTotalStudyMinutes() >= 300 },
      { id: 'study_20h',      icon: 'üî•', name: '‰∫åÂçÅÊôÇÈñì„ÅÆÁåõËÄÖ',  desc: 'Á¥ØË®à20ÊôÇÈñì„ÅÆÈÅ†ÂæÅ„ÇíÈÅîÊàê',       check: () => getTotalStudyMinutes() >= 1200 },
      { id: 'study_50h',      icon: '‚≠ê', name: '‰∫îÂçÅÊôÇÈñì„ÅÆË≥¢ËÄÖ',  desc: 'Á¥ØË®à50ÊôÇÈñì„ÅÆÈÅ†ÂæÅ„ÇíÈÅîÊàê',       check: () => getTotalStudyMinutes() >= 3000 },
      // „Çπ„Éà„É™„Éº„ÇØÁ≥ª
      { id: 'streak_3',       icon: 'üî•', name: '‰∏âÊó•„ÅÆÁÅØÁÅ´',      desc: '3Êó•ÈÄ£Á∂ö„ÅßÈÅ†ÂæÅ„Åó„Åü',            check: () => AppState.streak.longest >= 3 },
      { id: 'streak_7',       icon: 'üî•', name: '‰∏ÉÊó•„ÅÆÁÇé',        desc: '7Êó•ÈÄ£Á∂ö„ÅßÈÅ†ÂæÅ„Åó„Åü',            check: () => AppState.streak.longest >= 7 },
      { id: 'streak_30',      icon: 'üî•', name: '‰∏âÂçÅÊó•„ÅÆÁÑî',      desc: '30Êó•ÈÄ£Á∂ö„ÅßÈÅ†ÂæÅ„Åó„Åü',           check: () => AppState.streak.longest >= 30 },
      // ÁâπÊÆä
      { id: 'kingdom_created', icon: 'üè∞', name: 'ÁéãÂõΩ„ÅÆÂ§úÊòé„Åë',   desc: 'ÁéãÂõΩ„Çí‰ΩúÊàê„Åó„Åü',               check: () => !!AppState.kingdom },
      { id: 'night_study',    icon: 'üåô', name: 'Ê∑±Â§ú„ÅÆÈÅ†ÂæÅ',      desc: 'Â§úÈñìÔºà22ÊôÇ‰ª•ÈôçÔºâ„Å´ÈÅ†ÂæÅ„Åó„Åü',   check: () => AppState.quests.some(q => { const h = new Date(q.completedAt).getHours(); return h >= 22 || h < 5; }) },
      { id: 'early_study',    icon: 'üåÖ', name: 'ÊöÅ„ÅÆÈ®éÂ£´',        desc: 'Êó©ÊúùÔºà6ÊôÇÂâçÔºâ„Å´ÈÅ†ÂæÅ„Åó„Åü',      check: () => AppState.quests.some(q => { const h = new Date(q.completedAt).getHours(); return h >= 4 && h < 6; }) }
    ];

    function getTotalStudyMinutes() {
      return AppState.quests.reduce((sum, q) => sum + (q.duration || 0), 0);
    }

    function checkAchievements() {
      const newlyUnlocked = [];
      ACHIEVEMENTS.forEach(ach => {
        if (AppState.achievements[ach.id]) return;
        if (ach.check()) {
          AppState.achievements[ach.id] = { unlockedAt: new Date().toISOString() };
          newlyUnlocked.push(ach);
        }
      });
      if (newlyUnlocked.length > 0) {
        saveState();
        renderAchievements();
        newlyUnlocked.forEach((ach, i) => {
          setTimeout(() => showAchievementPopup(ach), i * 800);
        });
      }
      return newlyUnlocked;
    }

    function showAchievementPopup(ach) {
      const popup = document.createElement('div');
      popup.className = 'achievement-popup';
      popup.innerHTML = '<div class="ach-pop-icon">' + ach.icon + '</div>' +
        '<div class="ach-pop-text"><span>ÂÆüÁ∏æËß£Èô§</span>' + ach.name + '</div>';
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 3000);
    }

    function renderAchievements() {
      const grid = document.getElementById('achievements-grid');
      if (!grid) return;
      const unlocked = ACHIEVEMENTS.filter(a => AppState.achievements[a.id]);
      document.getElementById('ach-unlocked').textContent = unlocked.length;
      document.getElementById('ach-total').textContent = ACHIEVEMENTS.length;
      document.getElementById('ach-longest-streak').textContent = AppState.streak.longest;

      grid.innerHTML = ACHIEVEMENTS.map(ach => {
        const data = AppState.achievements[ach.id];
        const isUnlocked = !!data;
        const dateStr = data ? new Date(data.unlockedAt).toLocaleDateString('ja-JP') : '';
        const progress = getAchievementProgress(ach);
        return '<div class="achievement-card ' + (isUnlocked ? 'unlocked' : 'locked') + '">' +
          '<div class="achievement-icon">' + ach.icon + '</div>' +
          '<div class="achievement-info">' +
            '<div class="achievement-name">' + ach.name + '</div>' +
            '<div class="achievement-desc">' + ach.desc + '</div>' +
            (isUnlocked ? '<div class="achievement-date">üèÜ ' + dateStr + ' ÈÅîÊàê</div>' : '') +
          '</div>' +
          (!isUnlocked && progress ? '<div class="achievement-progress">' + progress + '</div>' : '') +
        '</div>';
      }).join('');
    }

    function getAchievementProgress(ach) {
      const id = ach.id;
      if (id === 'quest_10') return AppState.quests.length + '/10';
      if (id === 'quest_30') return AppState.quests.length + '/30';
      if (id === 'quest_100') return AppState.quests.length + '/100';
      if (id === 'conquer_5') return AppState.territories.filter(t => t.conquered).length + '/5';
      if (id === 'conquer_10') return AppState.territories.filter(t => t.conquered).length + '/10';
      if (id === 'conquer_all') return AppState.territories.filter(t => t.conquered).length + '/' + AppState.territories.length;
      if (id === 'test_10') return AppState.testHistory.length + '/10';
      if (id === 'study_5h') return Math.floor(getTotalStudyMinutes() / 60) + '/5h';
      if (id === 'study_20h') return Math.floor(getTotalStudyMinutes() / 60) + '/20h';
      if (id === 'study_50h') return Math.floor(getTotalStudyMinutes() / 60) + '/50h';
      if (id === 'streak_3') return AppState.streak.longest + '/3';
      if (id === 'streak_7') return AppState.streak.longest + '/7';
      if (id === 'streak_30') return AppState.streak.longest + '/30';
      return '';
    }

    // === ÊâÄÊåÅÂìÅ„Ç∑„Çπ„ÉÜ„É† ===

    const ITEMS = [
      {
        id: 'memory_pen',
        icon: 'üñäÔ∏è',
        name: 'Ë®òÊÜ∂„ÅÆÁÅØÁ≠Ü',
        type: 'Á•ûÂÖ∑',
        desc: 'ÂøòÂç¥„ÅÆÈúß„Å´ÂØæÊäó„Åß„Åç„ÇãÂîØ‰∏Ä„ÅÆÁ•ûÂÖ∑„ÄÇ„Åì„ÅÆÁÅØÁ≠Ü„ÅßÁ∂¥„Å£„ÅüÊõ∏Á∞°„ÇíÁØùÁÅ´„Å´ÁÑö„Åπ„Çã„Å®„ÄÅÈúß„ÇíÊô¥„Çâ„ÅôÂäõ„ÅåÁîü„Åæ„Çå„Çã„ÄÇ',
        lore: '„Åã„Å§„Å¶ÁéãÂõΩ„ÅåÊ†ÑËèØ„ÇíË™á„Å£„ÅüÊôÇ‰ª£„ÄÅÁü•Ë≠ò„ÇíÂè∏„ÇãÂ§ßÊõ∏Â∫´„ÅÆÂ••Ê∑±„Åè„Å´ÂÆâÁΩÆ„Åï„Çå„Å¶„ÅÑ„Åü„Å®‰ºù„Çè„Çã„ÄÇÂøòÂç¥„ÅÆÈúß„ÅåÁéãÂõΩ„ÇíÈ£≤„ÅøËæº„Çì„Å†Êó•„ÄÅ„Åì„ÅÆÁÅØÁ≠Ü„Å†„Åë„ÅåÁéâÂ∫ß„ÅÆÈñì„ÅÆÁØùÁÅ´„Å®ÂÖ±„Å´ÂÖâ„ÇíÂ§±„Çè„Å™„Åã„Å£„Åü„ÄÇÁÅØÁ≠Ü„ÅåÈÅ∏„Çì„Å†ËÄÖ„Å†„Åë„Åå„Åù„ÅÆÂäõ„ÇíÂºï„ÅçÂá∫„Åõ„Çã„Å®„ÅÑ„ÅÜ„ÄÇ',
        obtain: 'auto'
      }
    ];

    function grantItem(itemId) {
      if (AppState.items[itemId]) return false;
      AppState.items[itemId] = { obtainedAt: new Date().toISOString() };
      saveState();
      return true;
    }

    function renderItems() {
      const grid = document.getElementById('items-grid');
      if (!grid) return;
      const owned = ITEMS.filter(i => AppState.items[i.id]);
      document.getElementById('item-owned').textContent = owned.length;
      document.getElementById('item-total').textContent = ITEMS.length;

      grid.innerHTML = ITEMS.map(item => {
        const data = AppState.items[item.id];
        const isOwned = !!data;
        return '<div class="item-card ' + (isOwned ? 'owned' : 'not-owned') + '" ' + (isOwned ? 'onclick="showItemDetail(\'' + item.id + '\')"' : '') + '>' +
          '<div class="item-icon">' + item.icon + '</div>' +
          '<div class="item-info">' +
            '<div class="item-name">' + (isOwned ? item.name : 'ÔºüÔºüÔºü') + '</div>' +
            '<div class="item-type">' + (isOwned ? item.type : 'Êú™ÂÖ•Êâã') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function showItemDetail(itemId) {
      const item = ITEMS.find(i => i.id === itemId);
      const data = AppState.items[itemId];
      if (!item || !data) return;
      document.getElementById('item-modal-title').textContent = item.name;
      document.getElementById('item-detail-icon').textContent = item.icon;
      document.getElementById('item-detail-name').textContent = item.name;
      document.getElementById('item-detail-type').textContent = item.type;
      document.getElementById('item-detail-desc').textContent = item.desc;
      document.getElementById('item-detail-lore').textContent = item.lore;
      document.getElementById('item-detail-date').textContent = 'ÂÖ•ÊâãÊó•: ' + new Date(data.obtainedAt).toLocaleDateString('ja-JP');
      document.getElementById('item-detail-modal').classList.add('active');
    }

    // === „Çπ„Éà„É™„Éº„ÇØÔºàÈÄ£Á∂öÂ≠¶ÁøíÔºâÊ©üËÉΩ ===

    const STREAK_MILESTONES = [
      { days: 3,  title: 'Ë¶ãÁøí„ÅÑÂÜíÈô∫ËÄÖ', message: '‰∏âÊó•Âùä‰∏ª„ÅÆÂ£Å„ÇíÁ™ÅÁ†¥„Åï„Çå„Åæ„Åó„ÅüÔºÅ\nÁ¥†Êô¥„Çâ„Åó„ÅÑÁ¨¨‰∏ÄÊ≠©„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ' },
      { days: 7,  title: 'ÁÜüÁ∑¥„ÅÆÊé¢Á¥¢ËÄÖ', message: '‰∏ÄÈÄ±Èñì„ÅÆÈÄ£Á∂öÈÅ†ÂæÅÔºÅ\nÂ≠¶Áøí„ÅÆÁøíÊÖ£„ÅåË∫´„Å´„Å§„ÅÑ„Å¶„Åæ„ÅÑ„Çä„Åæ„Åó„Åü„Å≠„ÄÇ' },
      { days: 14, title: '‰∏çÂ±à„ÅÆÊà¶Â£´',   message: '‰∫åÈÄ±Èñì„ÄÅ‰ºë„Åæ„ÅöÊ≠©„ÅøÁ∂ö„Åë„Çã„Å®„ÅØ...\nË≤¥ÊñπÊßò„ÅÆÊÑèÂøó„ÅÆÂº∑„Åï„Å´ÊÑüÊúç„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ' },
      { days: 30, title: '‰ºùË™¨„ÅÆÁéã',     message: '‰∏âÂçÅÊó•Èñì„ÅÆÈÄ£Á∂öÈÅ†ÂæÅ...ÔºÅ\nË≤¥ÊñπÊßò„Åì„Åù„ÄÅÁúü„ÅÆÁéã„Å´„Åµ„Åï„Çè„Åó„ÅÑ„ÅäÊñπ„Åß„Åô„ÄÇ' }
    ];

    function getTodayStr() {
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      return jst.getFullYear() + '-' + String(jst.getMonth() + 1).padStart(2, '0') + '-' + String(jst.getDate()).padStart(2, '0');
    }

    function getYesterdayStr() {
      const now = new Date();
      const jst = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Tokyo' }));
      jst.setDate(jst.getDate() - 1);
      return jst.getFullYear() + '-' + String(jst.getMonth() + 1).padStart(2, '0') + '-' + String(jst.getDate()).padStart(2, '0');
    }

    // Ëµ∑ÂãïÊôÇ„ÅÆ„Çπ„Éà„É™„Éº„ÇØÂà§ÂÆöÔºà'continued' / 'broken' / 'same_day' / 'new'Ôºâ
    function checkStreakStatus() {
      const today = getTodayStr();
      const yesterday = getYesterdayStr();
      const last = AppState.streak.lastStudyDate;
      if (!last) return 'new';
      if (last === today) return 'same_day';
      if (last === yesterday) return 'continued';
      return 'broken';
    }

    // Â≠¶Áøí„ÇíË®òÈå≤„Åó„ÅüÊó•„ÅÆ„Çπ„Éà„É™„Éº„ÇØÊõ¥Êñ∞Ôºà„ÇØ„Ç®„Çπ„Éà‰øùÂ≠ò„Éª„Çø„Ç§„Éû„ÉºÂÆå‰∫ÜÊôÇ„Å´Âëº„Å∂Ôºâ
    function recordStudyDay() {
      const today = getTodayStr();
      if (AppState.streak.lastStudyDate === today) {
        updateStreakUI();
        return null;
      }

      const status = checkStreakStatus();
      if (status === 'continued' || status === 'new') {
        AppState.streak.current++;
      } else if (status === 'broken') {
        AppState.streak.current = 1;
      }
      AppState.streak.lastStudyDate = today;
      if (AppState.streak.current > AppState.streak.longest) {
        AppState.streak.longest = AppState.streak.current;
      }
      saveState();
      updateStreakUI();

      // „Éû„Ç§„É´„Çπ„Éà„Éº„É≥Âà§ÂÆö
      const milestone = STREAK_MILESTONES.find(m => m.days === AppState.streak.current && !AppState.streak.titles.includes(m.title));
      if (milestone) {
        AppState.streak.titles.push(milestone.title);
        saveState();
        return milestone;
      }
      return null;
    }

    function updateStreakUI() {
      if (AppState.streak.current > 0) {
        elements.streakDisplay.style.display = '';
        elements.streakCount.textContent = AppState.streak.current;
      } else {
        elements.streakDisplay.style.display = 'none';
      }
    }

    function showMilestonePopup(milestone) {
      const overlay = document.createElement('div');
      overlay.className = 'streak-milestone';
      overlay.innerHTML = '<div class="milestone-icon">üèÜ</div>' +
        '<div class="milestone-title">Áß∞Âè∑Áç≤Âæó</div>' +
        '<div class="milestone-subtitle">„Äå' + milestone.title + '„Äç</div>' +
        '<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:1rem;">üî• ÈÄ£Á∂ö' + milestone.days + 'Êó•ÈÅîÊàêÔºÅ</div>' +
        '<button class="milestone-btn">„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ</button>';
      document.body.appendChild(overlay);
      overlay.querySelector('.milestone-btn').addEventListener('click', () => {
        overlay.remove();
        const d = expandTemplate(CLAIRE_EVENTS.streakMilestone, { streak: milestone.days, title: milestone.title, message: milestone.message });
        showDialogue(d.text, d.expression, [{ label: 'Êõ∏Á∞°„ÇíÁ∂¥„Çã', value: 'Êõ∏Á∞°„ÇíÁ∂¥„Çä„Åü„ÅÑ' }, { label: 'Êàª„Çã', value: '„É°„Ç§„É≥„Å´Êàª„Çã' }]);
      });
    }

    // Ëµ∑ÂãïÊôÇ„Çπ„Éà„É™„Éº„ÇØÂá¶ÁêÜÔºàgetInitialGreetingÂÜÖ„Åß‰ΩøÁî®Ôºâ
    function processStreakOnInit() {
      const status = checkStreakStatus();
      if (status === 'broken' && AppState.streak.current > 0) {
        AppState.streak.current = 0;
        saveState();
      }
      updateStreakUI();
    }

    init();
  </script>
</body>
</html>
